var bt=Object.defineProperty;var St=(p,t,s)=>t in p?bt(p,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):p[t]=s;var o=(p,t,s)=>St(p,typeof t!="symbol"?t+"":t,s);import"../chunks/Bzak7iHL.js";import"../chunks/DrS1WK7l.js";import{o as Mt,a as xt}from"../chunks/D-KRtMmF.js";import{h as rt,aO as kt,t as Ct,a1 as _t,a4 as ht,a6 as At,a7 as at,a9 as ot,aa as Dt,w,v as k,a8 as g,a5 as S,x as M,ad as y}from"../chunks/BaFMXX1b.js";import{g as Q,e as Lt,a as _}from"../chunks/CcETWVYL.js";import{i as Bt}from"../chunks/BsF4dGg2.js";import{a as Tt}from"../chunks/BkCE2b-i.js";import{b as Pt}from"../chunks/_Chv9gBj.js";import{s as zt}from"../chunks/Bd-89TeU.js";import{i as It}from"../chunks/BDHLh8UG.js";import{h as Et,i as Rt,j as $,V as A,B as U,k as C,l as j,m as nt,n as q,G as Y,S as Gt,P as $t,W as Xt,C as Ft,a as Zt,I as Ht,R as Vt,b as Wt,c as Kt,E as Nt,T as Ot,d as Ut,A as jt,M as J}from"../chunks/tXehg3D1.js";import{s as P}from"../chunks/DSzE6Y4I.js";function ct(p,t,s,e){var i=p.__style;if(rt||i!==t){var r=Tt(t);(!rt||r!==p.getAttribute("style"))&&(r==null?p.removeAttribute("style"):p.style.cssText=r),p.__style=t}return e}function qt(p,t,s){var e=kt(p,t);e&&e.set&&(p[t]=s,Ct(()=>{p[t]=null}))}class Z{static disposeMaterial(t){if(!t)return;const s=e=>{var i,r;e.map&&((r=(i=e.map).dispose)==null||r.call(i)),e.dispose()};Array.isArray(t)?t.forEach(s):s(t)}static disposeObject(t){t.traverse(s=>{var e,i,r,n;s.geometry&&((i=(e=s.geometry).dispose)==null||i.call(e)),s.material&&Z.disposeMaterial(s.material),s instanceof Et&&((r=s.dispose)==null||r.call(s)),s instanceof Rt&&((n=s.userData)!=null&&n.dispose)&&s.userData.dispose()})}static disposeScene(t){t.traverse(s=>{var e,i;s.geometry&&((i=(e=s.geometry).dispose)==null||i.call(e)),s.material&&Z.disposeMaterial(s.material)})}}class Yt{constructor(t){this.obstacles=t}resolve(t,s,e){let i=!1;const r=new $,n=new $((e.minX+e.maxX)*.5,(e.minZ+e.maxZ)*.5),h=new $((e.maxX-e.minX)*.5,(e.maxZ-e.minZ)*.5);for(const d of this.obstacles){const u=new $((d.aabb.minX+d.aabb.maxX)*.5,(d.aabb.minZ+d.aabb.maxZ)*.5),a=new $((d.aabb.maxX-d.aabb.minX)*.5,(d.aabb.maxZ-d.aabb.minZ)*.5),c=n.x-u.x,f=n.y-u.y,m=h.x+a.x-Math.abs(c),b=h.y+a.y-Math.abs(f);if(m>0&&b>0)if(i=!0,m<b){const L=Math.sign(c)||1;r.set(m*L,0),t.x+=r.x,n.x+=r.x,s.x*=-.2}else{const L=Math.sign(f)||1;r.set(0,b*L),t.z+=r.y,n.y+=r.y,s.z*=-.2}}return i}}class Jt{constructor(t){o(this,"checkpoints",[]);o(this,"currentIndex",0);o(this,"lapStart",performance.now());o(this,"currentLapMs",0);o(this,"bestLapMs",null);this.checkpoints=t}update(t,s){this.currentLapMs=t-this.lapStart;const e=this.checkpoints[this.currentIndex];if(e&&s.distanceTo(e.position)<=e.radius&&(this.currentIndex++,this.currentIndex>=this.checkpoints.length)){const i=this.currentLapMs;(this.bestLapMs===null||i<this.bestLapMs)&&(this.bestLapMs=i),this.lapStart=t,this.currentLapMs=0,this.currentIndex=0}}getHudTimes(){return{current:this.currentLapMs,best:this.bestLapMs}}}class Qt{constructor(){o(this,"score",0);o(this,"distance",0);o(this,"combo",0);o(this,"lastScoreTime",0);o(this,"comboDecayTime",3e3);o(this,"lastPosition",new A);o(this,"startTime",0);this.startTime=performance.now(),this.lastScoreTime=this.startTime}update(t,s,e){const i=performance.now(),r=s.distanceTo(this.lastPosition);if(this.distance+=r,this.lastPosition.copy(s),r>0){const n=Math.floor(r*10);this.addScore(n,"distance")}if(e>20){const n=Math.floor((e-20)*2);this.addScore(n,"speed")}i-this.lastScoreTime>this.comboDecayTime&&(this.combo=0)}addScore(t,s="general"){const e=performance.now();e-this.lastScoreTime<1e3?this.combo=Math.min(this.combo+1,10):this.combo=Math.max(1,this.combo);const i=t*this.combo;return this.score+=i,this.lastScoreTime=e,i}addObstacleAvoidanceBonus(){return this.addScore(50,"avoidance")}addNearMissBonus(){return this.addScore(25,"nearmiss")}subtractCollisionPenalty(){this.score=Math.max(0,this.score-100),this.combo=0}getScoreData(){return{total:this.score,distance:this.distance,combo:this.combo,lastScoreTime:this.lastScoreTime}}reset(){this.score=0,this.distance=0,this.combo=0,this.lastScoreTime=performance.now(),this.lastPosition.set(0,0,0)}}class te{constructor(t,s){o(this,"scene");o(this,"camera");o(this,"particleGroups",[]);o(this,"screenShakeIntensity",0);o(this,"screenShakeDecay",.95);o(this,"originalCameraPosition",new A);this.scene=t,this.camera=s}update(t){this.updateParticles(t),this.updateScreenShake(t),this.cleanupParticles()}createCollisionEffect(t,s=1){this.createSparks(t,s),this.createDebris(t,s),this.addScreenShake(s*.5)}createBoostEffect(t){const e=new U,i=new Float32Array(60),r=new Float32Array(60),n=new Float32Array(20);for(let a=0;a<20;a++)i[a*3]=t.x+(Math.random()-.5)*2,i[a*3+1]=t.y+Math.random()*.5,i[a*3+2]=t.z-Math.random()*3,r[a*3]=.2+Math.random()*.3,r[a*3+1]=.8+Math.random()*.2,r[a*3+2]=1,n[a]=Math.random()*.1+.05;e.setAttribute("position",new C(i,3)),e.setAttribute("color",new C(r,3)),e.setAttribute("size",new C(n,1));const h=new j({size:.1,vertexColors:!0,blending:nt,transparent:!0,opacity:.8}),d=new q(e,h),u=new Y;u.add(d),u.startTime=performance.now(),u.duration=1e3,u.type="boost",this.scene.add(u),this.particleGroups.push(u)}createSparks(t,s){const e=Math.floor(20*s),i=new U,r=new Float32Array(e*3),n=new Float32Array(e*3),h=new Float32Array(e*3);for(let c=0;c<e;c++)r[c*3]=t.x,r[c*3+1]=t.y,r[c*3+2]=t.z,n[c*3]=(Math.random()-.5)*10,n[c*3+1]=Math.random()*5+2,n[c*3+2]=(Math.random()-.5)*10,h[c*3]=1,h[c*3+1]=.5+Math.random()*.5,h[c*3+2]=0;i.setAttribute("position",new C(r,3)),i.setAttribute("velocity",new C(n,3)),i.setAttribute("color",new C(h,3));const d=new j({size:.05,vertexColors:!0,blending:nt,transparent:!0}),u=new q(i,d),a=new Y;a.add(u),a.startTime=performance.now(),a.duration=1500,a.type="sparks",this.scene.add(a),this.particleGroups.push(a)}createDebris(t,s){const e=Math.floor(15*s),i=new U,r=new Float32Array(e*3),n=new Float32Array(e*3),h=new Float32Array(e*3);for(let c=0;c<e;c++){r[c*3]=t.x+(Math.random()-.5)*.5,r[c*3+1]=t.y+Math.random()*.5,r[c*3+2]=t.z+(Math.random()-.5)*.5,n[c*3]=(Math.random()-.5)*3,n[c*3+1]=Math.random()*2+1,n[c*3+2]=(Math.random()-.5)*3;const f=.3+Math.random()*.4;h[c*3]=f,h[c*3+1]=f*.8,h[c*3+2]=f*.6}i.setAttribute("position",new C(r,3)),i.setAttribute("velocity",new C(n,3)),i.setAttribute("color",new C(h,3));const d=new j({size:.08,vertexColors:!0,transparent:!0,opacity:.7}),u=new q(i,d),a=new Y;a.add(u),a.startTime=performance.now(),a.duration=2e3,a.type="debris",this.scene.add(a),this.particleGroups.push(a)}updateParticles(t){const s=performance.now();this.particleGroups.forEach(e=>{var f;const i=s-e.startTime,r=e.duration,n=i/r;if(n>=1)return;const h=e.children[0],d=h.geometry,u=d.attributes.position.array,a=(f=d.attributes.velocity)==null?void 0:f.array;if(a){for(let m=0;m<u.length;m+=3)u[m]+=a[m]*t,u[m+1]+=a[m+1]*t,u[m+2]+=a[m+2]*t,a[m+1]-=9.8*t;d.attributes.position.needsUpdate=!0}const c=h.material;c.opacity=1-n})}addScreenShake(t){this.screenShakeIntensity=Math.max(this.screenShakeIntensity,t)}updateScreenShake(t){if(this.screenShakeIntensity>0){const s=(Math.random()-.5)*this.screenShakeIntensity,e=(Math.random()-.5)*this.screenShakeIntensity,i=(Math.random()-.5)*this.screenShakeIntensity;this.originalCameraPosition.length()===0&&this.originalCameraPosition.copy(this.camera.position),this.camera.position.add(new A(s,e,i)),this.screenShakeIntensity*=this.screenShakeDecay,this.screenShakeIntensity<.001&&(this.screenShakeIntensity=0)}}cleanupParticles(){const t=performance.now();this.particleGroups=this.particleGroups.filter(s=>{const e=t-s.startTime,i=s.duration;return e>=i?(this.scene.remove(s),!1):!0})}dispose(){this.particleGroups.forEach(t=>{this.scene.remove(t)}),this.particleGroups=[]}}class ee{constructor(t){o(this,"scene");o(this,"camera");o(this,"renderer");o(this,"clock");o(this,"physics");o(this,"input");o(this,"renderSystem");o(this,"chaseCamera");o(this,"running",!1);o(this,"disposeBag",[]);o(this,"car");o(this,"track");o(this,"collision");o(this,"lap");o(this,"score");o(this,"effects");o(this,"audio");o(this,"unsubSettings");o(this,"throttleInput",0);o(this,"steerSensitivity",1);o(this,"environment");o(this,"currentSpeed",0);o(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta();this.update(t),this.render(),requestAnimationFrame(this.loop)});o(this,"updateSize",()=>{var e,i;const t=window.innerWidth,s=window.innerHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(i=(e=this.renderSystem).updateSize)==null||i.call(e,t,s)});this.container=t,this.scene=new Gt,this.camera=new $t(60,1,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.renderer=new Xt({antialias:!0,alpha:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Ft,this.physics=new Zt,this.input=new Ht(t),this.renderSystem=new Vt(this.scene,this.camera,this.renderer),this.chaseCamera=new Wt(this.camera)}init(){const t=Q(P);this.renderer.setPixelRatio(Math.min(devicePixelRatio,t.graphics.resolution)),this.renderer.shadowMap.enabled=!!t.graphics.shadows,this.renderer.shadowMap.type=Kt,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new Nt(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Ot,this.scene.add(this.track.group),this.car=new Ut({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}}),this.car.setPosition(0,0,0),this.car.setHeading(0),this.scene.add(this.car.group),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.chaseCamera.update(0,this.car.group),this.collision=new Yt(this.track.obstacles),this.score=new Qt,this.effects=new te(this.scene,this.camera),this.audio=new jt(this.camera),this.applySettingsToAudio();const s=P.subscribe(()=>this.applySettingsToAudio());this.unsubSettings=()=>s();const e=async()=>{var r;await((r=this.audio)==null?void 0:r.resume()),window.removeEventListener("keydown",e,!0),this.disposeBag=this.disposeBag.filter(n=>n!==i)},i=()=>window.removeEventListener("keydown",e,!0);window.addEventListener("keydown",e,!0),this.disposeBag.push(i),this.lap=new Jt([{position:new A(0,0,100),radius:5},{position:new A(0,0,200),radius:5},{position:new A(0,0,300),radius:5},{position:new A(0,0,400),radius:5}]),this.running=!0,this.clock.start(),this.loop()}update(t){var E,R,B,T;this.physics.update(t);const s=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),e=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),i=this.input.isDown("Space"),r=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),n=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),h=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),d=J.clamp((n-h)*this.steerSensitivity,-1,1);this.car.setInputs({throttle:s,brake:e,steering:d,handbrake:i,boost:r}),this.throttleInput=s,this.car.update(t),this.currentSpeed=this.car.getSpeed(),this.chaseCamera.update(t,this.car.group),this.track.update(this.car.group.position.z),(E=this.environment)==null||E.update(this.car.group.position.z),this.score.update(t,this.car.group.position,this.currentSpeed),this.effects.update(t),(this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"))&&this.throttleInput>0&&this.effects.createBoostEffect(this.car.group.position);const a=this.car.group.position,c=.6,f=1.2,m={minX:a.x-c,maxX:a.x+c,minZ:a.z-f,maxZ:a.z+f},b=this.car.getVelocityRef().clone();if(this.collision.resolve(a,this.car.getVelocityRef(),m)){const H=this.car.getVelocityRef(),G=b.clone().sub(H),X=J.clamp(G.length()*.1,0,1);(R=this.audio)==null||R.playCollision(X),this.score.subtractCollisionPenalty(),this.effects.createCollisionEffect(this.car.group.position,X)}const z=25;Math.abs(a.x)>z&&(a.x=J.clamp(a.x,-z,z)),this.input.isDown("KeyR")&&this.car.reset(new A(0,0,0),0),this.lap.update(performance.now(),this.car.group.position),(B=this.audio)==null||B.setEngine(this.throttleInput,this.currentSpeed,this.car.config.maxSpeed);const I=((T=this.getBoostLevel)==null?void 0:T.call(this))??0;this.chaseCamera.setBoostVisual(1-I<.001?0:this.throttleInput>0?1-I*.2:0)}render(){this.renderSystem.render()}destroy(){var t,s,e;this.running=!1,this.clock.stop(),this.disposeBag.forEach(i=>i()),(t=this.unsubSettings)==null||t.call(this),(s=this.environment)==null||s.dispose(this.scene),Z.disposeScene(this.scene),this.renderer.dispose(),this.input.destroy(),(e=this.audio)==null||e.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getLapHud(){return this.lap.getHudTimes()}getBoostLevel(){var t;return(t=this.car)!=null&&t.getBoostLevel?this.car.getBoostLevel():0}getScore(){return this.score.getScoreData()}applySettingsToAudio(){var s,e;const t=Q(P);this.steerSensitivity=((s=t==null?void 0:t.controls)==null?void 0:s.sensitivity)??1,(e=this.audio)==null||e.updateFromSettings(t)}}var se=ht('<div class="combo svelte-4p1id7"> </div>'),ie=ht('<div class="game-root svelte-4p1id7"></div> <div class="hud svelte-4p1id7"><div class="score-section svelte-4p1id7"><div class="score svelte-4p1id7"> </div> <div class="distance svelte-4p1id7"> </div> <!></div> <div class="speed svelte-4p1id7"> </div> <div class="laps svelte-4p1id7"><div> </div> <div> </div></div> <div class="help svelte-4p1id7">W/S or ↑/↓: Throttle/Brake • A/D or ←/→: Steer • Space: Handbrake • Shift: Boost • R: Reset</div> <button class="mute svelte-4p1id7" aria-label="Toggle mute" title="Toggle mute"> </button> <div class="boost svelte-4p1id7"><div class="bar svelte-4p1id7"><div class="fill svelte-4p1id7"></div></div></div> <div class="speed-indicator svelte-4p1id7"><div class="speed-bar svelte-4p1id7"><div class="speed-fill svelte-4p1id7"></div></div> <div class="speed-text svelte-4p1id7"> </div></div></div>',1);function we(p,t){_t(t,!1);let s=k(null),e=null,i=k(0),r=k(0),n=k(null),h=k(!1),d=.8,u=k(1),a=k(0),c=k(0),f=k(0);Mt(()=>{if(!w(s))return;e=new ee(w(s)),e.init();const l=setInterval(()=>{var v;if(e){M(i,Math.round(e.currentSpeed*3.6));const x=(v=e.getLapHud)==null?void 0:v.call(e);if(x&&(M(r,x.current),M(n,x.best??null)),e.getBoostLevel&&M(u,e.getBoostLevel()),e.getScore){const D=e.getScore();M(a,D.total),M(c,Math.round(D.distance)),M(f,D.combo)}}},100);return()=>{clearInterval(l),e==null||e.destroy()}}),xt(()=>{e==null||e.destroy(),e=null});function m(){const l=Q(P);l.audio.master>0?(d=l.audio.master,P.update(v=>({...v,audio:{...v.audio,master:0}})),M(h,!0)):(P.update(v=>({...v,audio:{...v.audio,master:d||.8}})),M(h,!1))}function b(l){const v=Math.floor(l/6e4),x=Math.floor(l%6e4/1e3),D=Math.floor(l%1e3/10);return`${v}:${String(x).padStart(2,"0")}.${String(D).padStart(2,"0")}`}function L(l){return l<=20?"#00ff00":l<=40?"#7fff00":l<=60?"#ffff00":l<=80?"#ff7f00":l<=120?"#ff4500":l<=160?"#ff0000":"#ff00ff"}var z={formatMs:b};It();var I=ie(),E=At(I);Pt(E,l=>M(s,l),()=>w(s));var R=S(E,2),B=g(R),T=g(B),H=g(T);y(T);var G=S(T,2),X=g(G);y(G);var dt=S(G,2);{var lt=l=>{var v=se(),x=g(v);y(v),at(()=>_(x,`Combo: x${w(f)??""}`)),ot(l,v)};Bt(dt,l=>{w(f)>1&&l(lt)})}y(B);var V=S(B,2),pt=g(V);y(V);var W=S(V,2),K=g(W),ut=g(K);y(K);var tt=S(K,2),mt=g(tt);y(tt),y(W);var F=S(W,4),ft=g(F,!0);y(F);var N=S(F,2),et=g(N),vt=g(et);y(et),y(N);var st=S(N,2),O=g(st),wt=g(O);y(O);var it=S(O,2),gt=g(it);return y(it),y(st),y(R),at((l,v,x,D,yt)=>{_(H,`Score: ${l??""}`),_(X,`Distance: ${w(c)??""}m`),_(pt,`${w(i)??""} km/h`),_(ut,`Lap: ${v??""}`),_(mt,`Best: ${x??""}`),_(ft,w(h)?"Unmute":"Mute"),ct(vt,D),ct(wt,yt),_(gt,`${w(i)??""} km/h`)},[()=>w(a).toLocaleString(),()=>b(w(r)),()=>w(n)===null?"--":b(w(n)),()=>`width:${Math.round(w(u)*100)}%`,()=>`width:${Math.min(w(i)/200*100,100)}%; background: ${L(w(i))}`]),Lt("click",F,zt(m)),ot(p,I),qt(t,"formatMs",b),Dt(z)}export{we as component};
