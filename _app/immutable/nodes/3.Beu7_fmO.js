var xe=Object.defineProperty;var Ae=(f,e,s)=>e in f?xe(f,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):f[e]=s;var r=(f,e,s)=>Ae(f,typeof e!="symbol"?e+"":e,s);import"../chunks/Bzak7iHL.js";import"../chunks/BAWEk33w.js";import{g as ee,o as Ce,b as Te,a as A}from"../chunks/DeGFAstr.js";import{Q as _e,J as Ee,a6 as Le,a7 as ue,o as De,a8 as ce,aC as ze,t as de,a9 as Pe,aa as y,ab as v,A as m,M as k,N as S,ac as w}from"../chunks/CLtiFm-Q.js";import{i as Ie}from"../chunks/DgQJhhFg.js";import{s as He,b as he}from"../chunks/Blh6K_Xk.js";import{b as Ge}from"../chunks/CyGP8b_B.js";import{s as Re}from"../chunks/Bd-89TeU.js";import{i as $e}from"../chunks/V_1rYtVp.js";import{p as Fe,j as Ve,V as C,q as K,r as B,s as q,t as le,u as J,G as Q,S as We,P as Oe,W as Xe,C as Ne,a as Ue,I as Ze,R as je,b as Ke,c as qe,E as Je,T as Qe,e as Ye,d as et,A as tt,M as Y,H as st,m as it,n as rt,o as at}from"../chunks/BQjzqC9-.js";import{s as _}from"../chunks/prV4TT54.js";import{b as ot}from"../chunks/B6mXda80.js";function nt(f,e,s){var t=_e(f,e);t&&t.set&&(f[e]=s,Ee(()=>{f[e]=null}))}class ${static disposeMaterial(e){if(!e)return;const s=t=>{var i,a;t.map&&((a=(i=t.map).dispose)==null||a.call(i)),t.dispose()};Array.isArray(e)?e.forEach(s):s(e)}static disposeObject(e){e.traverse(s=>{var t,i,a,d;s.geometry&&((i=(t=s.geometry).dispose)==null||i.call(t)),s.material&&$.disposeMaterial(s.material),s instanceof Fe&&((a=s.dispose)==null||a.call(s)),s instanceof Ve&&((d=s.userData)!=null&&d.dispose)&&s.userData.dispose()})}static disposeScene(e){e.traverse(s=>{var t,i;s.geometry&&((i=(t=s.geometry).dispose)==null||i.call(t)),s.material&&$.disposeMaterial(s.material)})}}class ct{constructor(e){r(this,"checkpoints",[]);r(this,"currentIndex",0);r(this,"lapStart",performance.now());r(this,"currentLapMs",0);r(this,"bestLapMs",null);this.checkpoints=e}update(e,s){this.currentLapMs=e-this.lapStart;const t=this.checkpoints[this.currentIndex];if(t&&s.distanceTo(t.position)<=t.radius&&(this.currentIndex++,this.currentIndex>=this.checkpoints.length)){const i=this.currentLapMs;(this.bestLapMs===null||i<this.bestLapMs)&&(this.bestLapMs=i),this.lapStart=e,this.currentLapMs=0,this.currentIndex=0}}getHudTimes(){return{current:this.currentLapMs,best:this.bestLapMs}}}class dt{constructor(){r(this,"score",0);r(this,"distance",0);r(this,"combo",0);r(this,"lastScoreTime",0);r(this,"comboDecayTime",3e3);r(this,"lastPosition",new C);r(this,"startTime",0);this.startTime=performance.now(),this.lastScoreTime=this.startTime}update(e,s,t){const i=performance.now(),a=s.distanceTo(this.lastPosition);if(this.distance+=a,this.lastPosition.copy(s),a>0){const d=Math.floor(a*10);this.addScore(d,"distance")}if(t>20){const d=Math.floor((t-20)*2);this.addScore(d,"speed")}i-this.lastScoreTime>this.comboDecayTime&&(this.combo=0)}addScore(e,s="general"){const t=performance.now();t-this.lastScoreTime<1e3?this.combo=Math.min(this.combo+1,10):this.combo=Math.max(1,this.combo);const i=e*this.combo;return this.score+=i,this.lastScoreTime=t,i}addObstacleAvoidanceBonus(){return this.addScore(50,"avoidance")}addNearMissBonus(){return this.addScore(25,"nearmiss")}subtractCollisionPenalty(){this.score=Math.max(0,this.score-100),this.combo=0}getScoreData(){return{total:this.score,distance:this.distance,combo:this.combo,lastScoreTime:this.lastScoreTime}}reset(){this.score=0,this.distance=0,this.combo=0,this.lastScoreTime=performance.now(),this.lastPosition.set(0,0,0)}}class ht{constructor(e,s){r(this,"scene");r(this,"camera");r(this,"particleGroups",[]);r(this,"screenShakeIntensity",0);r(this,"screenShakeDecay",.95);r(this,"originalCameraPosition",new C);this.scene=e,this.camera=s}update(e){this.updateParticles(e),this.updateScreenShake(e),this.cleanupParticles()}createCollisionEffect(e,s=1){this.createSparks(e,s),this.createDebris(e,s),this.addScreenShake(s*.5)}createBoostEffect(e){const t=new K,i=new Float32Array(60),a=new Float32Array(60),d=new Float32Array(20);for(let o=0;o<20;o++)i[o*3]=e.x+(Math.random()-.5)*2,i[o*3+1]=e.y+Math.random()*.5,i[o*3+2]=e.z-Math.random()*3,a[o*3]=.2+Math.random()*.3,a[o*3+1]=.8+Math.random()*.2,a[o*3+2]=1,d[o]=Math.random()*.1+.05;t.setAttribute("position",new B(i,3)),t.setAttribute("color",new B(a,3)),t.setAttribute("size",new B(d,1));const p=new q({size:.1,vertexColors:!0,blending:le,transparent:!0,opacity:.8}),l=new J(t,p),u=new Q;u.add(l),u.startTime=performance.now(),u.duration=1e3,u.type="boost",this.scene.add(u),this.particleGroups.push(u)}createSparks(e,s){const t=Math.floor(20*s),i=new K,a=new Float32Array(t*3),d=new Float32Array(t*3),p=new Float32Array(t*3);for(let h=0;h<t;h++)a[h*3]=e.x,a[h*3+1]=e.y,a[h*3+2]=e.z,d[h*3]=(Math.random()-.5)*10,d[h*3+1]=Math.random()*5+2,d[h*3+2]=(Math.random()-.5)*10,p[h*3]=1,p[h*3+1]=.5+Math.random()*.5,p[h*3+2]=0;i.setAttribute("position",new B(a,3)),i.setAttribute("velocity",new B(d,3)),i.setAttribute("color",new B(p,3));const l=new q({size:.05,vertexColors:!0,blending:le,transparent:!0}),u=new J(i,l),o=new Q;o.add(u),o.startTime=performance.now(),o.duration=1500,o.type="sparks",this.scene.add(o),this.particleGroups.push(o)}createDebris(e,s){const t=Math.floor(15*s),i=new K,a=new Float32Array(t*3),d=new Float32Array(t*3),p=new Float32Array(t*3);for(let h=0;h<t;h++){a[h*3]=e.x+(Math.random()-.5)*.5,a[h*3+1]=e.y+Math.random()*.5,a[h*3+2]=e.z+(Math.random()-.5)*.5,d[h*3]=(Math.random()-.5)*3,d[h*3+1]=Math.random()*2+1,d[h*3+2]=(Math.random()-.5)*3;const b=.3+Math.random()*.4;p[h*3]=b,p[h*3+1]=b*.8,p[h*3+2]=b*.6}i.setAttribute("position",new B(a,3)),i.setAttribute("velocity",new B(d,3)),i.setAttribute("color",new B(p,3));const l=new q({size:.08,vertexColors:!0,transparent:!0,opacity:.7}),u=new J(i,l),o=new Q;o.add(u),o.startTime=performance.now(),o.duration=2e3,o.type="debris",this.scene.add(o),this.particleGroups.push(o)}updateParticles(e){const s=performance.now();this.particleGroups.forEach(t=>{var b;const i=s-t.startTime,a=t.duration,d=i/a;if(d>=1)return;const p=t.children[0],l=p.geometry,u=l.attributes.position.array,o=(b=l.attributes.velocity)==null?void 0:b.array;if(o){for(let g=0;g<u.length;g+=3)u[g]+=o[g]*e,u[g+1]+=o[g+1]*e,u[g+2]+=o[g+2]*e,o[g+1]-=9.8*e;l.attributes.position.needsUpdate=!0}const h=p.material;h.opacity=1-d})}addScreenShake(e){this.screenShakeIntensity=Math.max(this.screenShakeIntensity,e)}updateScreenShake(e){if(this.screenShakeIntensity>0){const s=(Math.random()-.5)*this.screenShakeIntensity,t=(Math.random()-.5)*this.screenShakeIntensity,i=(Math.random()-.5)*this.screenShakeIntensity;this.originalCameraPosition.length()===0&&this.originalCameraPosition.copy(this.camera.position),this.camera.position.add(new C(s,t,i)),this.screenShakeIntensity*=this.screenShakeDecay,this.screenShakeIntensity<.001&&(this.screenShakeIntensity=0)}}cleanupParticles(){const e=performance.now();this.particleGroups=this.particleGroups.filter(s=>{const t=e-s.startTime,i=s.duration;return t>=i?(this.scene.remove(s),!1):!0})}dispose(){this.particleGroups.forEach(e=>{this.scene.remove(e)}),this.particleGroups=[]}}class lt{constructor(e){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"clock");r(this,"physics");r(this,"input");r(this,"renderSystem");r(this,"chaseCamera");r(this,"running",!1);r(this,"disposeBag",[]);r(this,"car");r(this,"track");r(this,"collision");r(this,"lap");r(this,"score");r(this,"effects");r(this,"audio");r(this,"unsubSettings");r(this,"throttleInput",0);r(this,"steerSensitivity",1);r(this,"environment");r(this,"gameMode");r(this,"frameTimeBuffer",[]);r(this,"frameTimeBufferSize",5);r(this,"currentSpeed",0);r(this,"loop",()=>{if(!this.running)return;const e=this.clock.getDelta(),s=Math.min(e,.1);this.frameTimeBuffer.push(s),this.frameTimeBuffer.length>this.frameTimeBufferSize&&this.frameTimeBuffer.shift();const t=this.frameTimeBuffer.reduce((i,a)=>i+a,0)/this.frameTimeBuffer.length;this.update(t),this.render(),requestAnimationFrame(this.loop)});r(this,"updateSize",()=>{var t,i;const e=window.innerWidth,s=window.innerHeight;this.camera.aspect=e/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,s,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(i=(t=this.renderSystem).updateSize)==null||i.call(t,e,s)});this.container=e,this.scene=new We,this.camera=new Oe(60,1,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.renderer=new Xe({antialias:!0,alpha:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Ne,this.physics=new Ue,this.input=new Ze(e),this.renderSystem=new je(this.scene,this.camera,this.renderer),this.chaseCamera=new Ke(this.camera)}init(){const e=ee(_);this.renderer.setPixelRatio(Math.min(devicePixelRatio,e.graphics.resolution)),this.renderer.shadowMap.enabled=!!e.graphics.shadows,this.renderer.shadowMap.type=qe,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.initializeGameMode(e.gameplay.gameMode),this.environment=new Je(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Qe,this.scene.add(this.track.group),this.car=new Ye({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}}),this.car.setPosition(0,0,0),this.car.setHeading(0),this.scene.add(this.car.group),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.chaseCamera.update(0,this.car.group),this.collision=new et(this.track.obstacles),this.score=new dt,this.effects=new ht(this.scene,this.camera),this.audio=new tt(this.camera),this.applySettingsToAudio();const s=_.subscribe(()=>this.applySettingsToAudio());this.unsubSettings=()=>s();const t=async()=>{var a;await((a=this.audio)==null?void 0:a.resume()),window.removeEventListener("keydown",t,!0),window.removeEventListener("pointerdown",t,!0),this.disposeBag=this.disposeBag.filter(d=>d!==i)},i=()=>{window.removeEventListener("keydown",t,!0),window.removeEventListener("pointerdown",t,!0)};window.addEventListener("keydown",t,!0),window.addEventListener("pointerdown",t,!0),this.disposeBag.push(i),this.lap=new ct([{position:new C(0,0,100),radius:5},{position:new C(0,0,200),radius:5},{position:new C(0,0,300),radius:5},{position:new C(0,0,400),radius:5}]),this.running=!0,this.clock.start(),this.loop()}update(e){var D,z,P,I,H;this.physics.update(e);const s=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),t=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),i=this.input.isDown("Space"),a=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),d=Y.clamp(this.input.getSteerValue()*this.steerSensitivity,-1,1);this.car.setInputs({throttle:s,brake:t,steering:d,handbrake:i,boost:a}),this.throttleInput=s,this.car.update(e),this.currentSpeed=this.car.getSpeed(),this.chaseCamera.update(e,this.car.group),this.track.update(this.car.group.position.z),(D=this.environment)==null||D.update(this.car.group.position.z),(z=this.gameMode)==null||z.updateEnvironment(e,this.car.group.position),this.score.update(e,this.car.group.position,this.currentSpeed),this.effects.update(e),(this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"))&&this.throttleInput>0&&this.effects.createBoostEffect(this.car.group.position);const l=this.car.group.position,u=.6,o=1.2,h={minX:l.x-u,maxX:l.x+u,minZ:l.z-o,maxZ:l.z+o},b=this.car.getVelocityRef().clone();if(this.collision.resolve(l,this.car.getVelocityRef(),h)){const F=this.car.getVelocityRef(),G=b.clone().sub(F),E=Y.clamp(G.length()*.1,0,1);(P=this.audio)==null||P.playCollision(E),this.score.subtractCollisionPenalty(),this.effects.createCollisionEffect(this.car.group.position,E)}const x=25;Math.abs(l.x)>x&&(l.x=Y.clamp(l.x,-x,x)),this.input.isDown("KeyR")&&this.car.reset(new C(0,0,0),0),this.lap.update(performance.now(),this.car.group.position),(I=this.audio)==null||I.setEngine(this.throttleInput,this.currentSpeed,this.car.config.maxSpeed);const L=((H=this.getBoostLevel)==null?void 0:H.call(this))??0;this.chaseCamera.setBoostVisual(1-L<.001?0:this.throttleInput>0?1-L*.2:0)}render(){this.renderSystem.render()}destroy(){var e,s,t,i;this.running=!1,this.clock.stop(),this.disposeBag.forEach(a=>a()),(e=this.unsubSettings)==null||e.call(this),(s=this.gameMode)==null||s.dispose(),(t=this.environment)==null||t.dispose(this.scene),$.disposeScene(this.scene),this.renderer.dispose(),this.input.destroy(),(i=this.audio)==null||i.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getLapHud(){return this.lap.getHudTimes()}getBoostLevel(){var e;return(e=this.car)!=null&&e.getBoostLevel?this.car.getBoostLevel():0}getScore(){return this.score.getScoreData()}applySettingsToAudio(){var s,t;const e=ee(_);this.steerSensitivity=((s=e==null?void 0:e.controls)==null?void 0:s.sensitivity)??1,(t=this.audio)==null||t.updateFromSettings(e)}initializeGameMode(e){var s;switch(this.audio&&(e!=="horror"?this.audio.disableHorrorAmbient():(this.audio.enableHorrorAmbient(),this.startHorrorEffects())),(s=this.gameMode)==null||s.dispose(),e){case"sunny":this.gameMode=new rt;break;case"cloudy":this.gameMode=new it;break;case"horror":this.gameMode=new st;break}this.gameMode.initialize(this.scene,this.renderer)}switchGameMode(e){this.initializeGameMode(e)}startHorrorEffects(){const e=()=>{if(!this.audio||!this.running)return;const s=8e3+Math.random()*17e3;setTimeout(()=>{if(!this.audio||!this.running)return;const t=["whisper","creak","distant-scream","heartbeat"],i=t[Math.floor(Math.random()*t.length)];this.audio.playHorrorEffect(i),e()},s)};e()}}var ut=ue('<div class="combo svelte-4p1id7"> </div>'),pt=ue('<div class="game-root svelte-4p1id7"></div> <!> <div class="hud svelte-4p1id7"><a class="home-btn svelte-4p1id7" aria-label="Home" title="Home" style="pointer-events:auto">Home</a> <div class="score-section svelte-4p1id7"><div class="score svelte-4p1id7"> </div> <div class="distance svelte-4p1id7"> </div> <!></div> <div class="speed svelte-4p1id7"> </div> <div class="laps svelte-4p1id7"><div> </div> <div> </div></div> <div class="help svelte-4p1id7">W/S or ↑/↓: Throttle/Brake • A/D or ←/→: Steer • Space: Handbrake • Shift: Boost • R: Reset</div> <button class="mute svelte-4p1id7" aria-label="Toggle mute" title="Toggle mute"> </button> <div class="boost svelte-4p1id7"><div class="bar svelte-4p1id7"><div class="fill svelte-4p1id7"></div></div></div> <div class="speed-indicator svelte-4p1id7"><div class="speed-bar svelte-4p1id7"><div class="speed-fill svelte-4p1id7"></div></div> <div class="speed-text svelte-4p1id7"> </div></div></div>',1);function Ct(f,e){Le(e,!1);let s=k(null),t=null,i=k(0),a=k(0),d=k(null),p=k(!1),l=.8,u=k(1),o=k(0),h=k(0),b=k(0);Ce(()=>{if(typeof document<"u"&&(document.documentElement.style.overflow="hidden",document.body.style.overflow="hidden"),!m(s))return;t=new lt(m(s)),t.init();const n=setInterval(()=>{var c;if(t){S(i,Math.round(t.currentSpeed*3.6));const M=(c=t.getLapHud)==null?void 0:c.call(t);if(M&&(S(a,M.current),S(d,M.best??null)),t.getBoostLevel&&S(u,t.getBoostLevel()),t.getScore){const T=t.getScore();S(o,T.total),S(h,Math.round(T.distance)),S(b,T.combo)}}},100);return()=>{clearInterval(n),t==null||t.destroy()}}),Te(()=>{t==null||t.destroy(),t=null,typeof document<"u"&&(document.documentElement.style.overflow="",document.body.style.overflow="")});function g(){const n=ee(_);n.audio.master>0?(l=n.audio.master,_.update(c=>({...c,audio:{...c.audio,master:0}})),S(p,!0)):(_.update(c=>({...c,audio:{...c.audio,master:l||.8}})),S(p,!1))}function x(n){const c=Math.floor(n/6e4),M=Math.floor(n%6e4/1e3),T=Math.floor(n%1e3/10);return`${c}:${String(M).padStart(2,"0")}.${String(T).padStart(2,"0")}`}function L(n){return n<=20?"#00ff00":n<=40?"#7fff00":n<=60?"#ffff00":n<=80?"#ff7f00":n<=120?"#ff4500":n<=160?"#ff0000":"#ff00ff"}function D(n){var c;(c=t==null?void 0:t.input)==null||c.setMobileThrottle(n)}function z(n){var c;(c=t==null?void 0:t.input)==null||c.setMobileBrake(n)}function P(n){var c;(c=t==null?void 0:t.input)==null||c.setMobileSteer(n)}function I(n){var c;(c=t==null?void 0:t.input)==null||c.setMobileHandbrake(n)}function H(n){var c;(c=t==null?void 0:t.input)==null||c.setMobileBoost(n)}var F={formatMs:x};$e();var G=pt(),E=De(G);Ge(E,n=>S(s,n),()=>m(s));var te=y(E,2);at(te,{onThrottle:D,onBrake:z,onSteer:P,onHandbrake:I,onBoost:H});var se=y(te,2),ie=v(se),V=y(ie,2),W=v(V),pe=v(W);w(W);var O=y(W,2),me=v(O);w(O);var fe=y(O,2);{var ve=n=>{var c=ut(),M=v(c);w(c),ce(()=>A(M,`Combo: x${m(b)??""}`)),de(n,c)};Ie(fe,n=>{m(b)>1&&n(ve)})}w(V);var X=y(V,2),we=v(X);w(X);var N=y(X,2),U=v(N),be=v(U);w(U);var re=y(U,2),ge=v(re);w(re),w(N);var R=y(N,4),ye=v(R,!0);w(R);var Z=y(R,2),ae=v(Z),Se=v(ae);w(ae),w(Z);var oe=y(Z,2),j=v(oe),Me=v(j);w(j);var ne=y(j,2),ke=v(ne);return w(ne),w(oe),w(se),ce((n,c,M,T,Be)=>{He(ie,"href",`${ot}/`),A(pe,`Score: ${n??""}`),A(me,`Distance: ${m(h)??""}m`),A(we,`${m(i)??""} km/h`),A(be,`Lap: ${c??""}`),A(ge,`Best: ${M??""}`),A(ye,m(p)?"Unmute":"Mute"),he(Se,T),he(Me,Be),A(ke,`${m(i)??""} km/h`)},[()=>m(o).toLocaleString(),()=>x(m(a)),()=>m(d)===null?"--":x(m(d)),()=>`width:${Math.round(m(u)*100)}%`,()=>`width:${Math.min(m(i)/200*100,100)}%; background: ${L(m(i))}`]),ze("click",R,Re(g)),de(f,G),nt(e,"formatMs",x),Pe(F)}export{Ct as component};
