var me=Object.defineProperty;var fe=(_,t,e)=>t in _?me(_,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):_[t]=e;var i=(_,t,e)=>fe(_,typeof t!="symbol"?t+"":t,e);import"../chunks/Bzak7iHL.js";import"../chunks/BrFi3U2L.js";import{o as we,a as ye}from"../chunks/CQ9e226j.js";import{av as ce,W as ee,Z as G,O as ge,Q as ve,R as be,T as j,X as q,_ as Se,d as f,$ as E,b as a,V as U,Y as $,a2 as L,u as ie}from"../chunks/BLUA93ud.js";import{g as ne,s as B,e as ze}from"../chunks/DJBBIPgZ.js";import{i as Y}from"../chunks/jR7hMorV.js";import{I as Ie,e as _e,f as ke}from"../chunks/LrYnITb2.js";import{b as Re}from"../chunks/BB5eFctZ.js";import{i as Ae}from"../chunks/DVwO53S4.js";import{s as xe,a as Me}from"../chunks/B9MN4c6Y.js";import{R as De,p as Pe}from"../chunks/DfdHNEbt.js";import{S as Te,P as Ce,W as Ee,C as $e,a as Le,I as We,R as Ne,b as He,c as Ue,E as Ge,T as Ve,d as Fe,e as oe,A as Xe,M as F,V as le,Q as Ze,f as Be,L as je,g as Oe,h as qe}from"../chunks/DXnvPKNF.js";import{s as J}from"../chunks/5OWoQgaB.js";import"../chunks/Mn_WePyN.js";import{s as Ke}from"../chunks/DwKbMMYR.js";import{l as Qe,s as Ye}from"../chunks/CVTru5AP.js";function Je(_,t){const e=Qe(t,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"}],["path",{d:"M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"}],["path",{d:"M18 9h1.5a1 1 0 0 0 0-5H18"}],["path",{d:"M4 22h16"}],["path",{d:"M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"}],["path",{d:"M6 9H4.5a1 1 0 0 1 0-5H6"}]];Ie(_,Ye({name:"trophy"},()=>e,{get iconNode(){return s},children:(n,c)=>{var h=ce(),r=ee(h);Ke(r,t,"default",{}),G(n,h)},$$slots:{default:!0}}))}class et{constructor(t,e){i(this,"scene");i(this,"camera");i(this,"renderer");i(this,"clock");i(this,"physics");i(this,"input");i(this,"renderSystem");i(this,"chaseCamera");i(this,"environment");i(this,"track");i(this,"audio");i(this,"collision");i(this,"running",!1);i(this,"disposeBag",[]);i(this,"players",new Map);i(this,"localId");i(this,"countdown",3);i(this,"countdownStartAt",null);i(this,"raceStarted",!1);i(this,"finishZ",600);i(this,"winnerId",null);i(this,"frozen",!1);i(this,"currentSpeed",0);i(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta();this.update(t),this.render(),requestAnimationFrame(this.loop)});i(this,"updateSize",()=>{var s,n;const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(n=(s=this.renderSystem).updateSize)==null||n.call(s,t,e)});var n;this.container=t,this.scene=new Te,this.camera=new Ce(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new Ee({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new $e,this.physics=new Le,this.input=new We(t),this.renderSystem=new Ne(this.scene,this.camera,this.renderer),this.chaseCamera=new He(this.camera);const s=e.find(c=>c.isLocal);this.localId=s?s.id:(n=e[0])==null?void 0:n.id,e.forEach(c=>{this.players.set(c.id,{info:c,car:null,label:null})})}init(t){const e=ne(J);this.renderer.setPixelRatio(Math.min(devicePixelRatio,e.graphics.resolution)),this.renderer.shadowMap.enabled=!!e.graphics.shadows,this.renderer.shadowMap.type=Ue,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new Ge(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Ve,this.scene.add(this.track.group),this.collision=new Fe(this.track.obstacles),Array.from(this.players.keys()).forEach(h=>{const r=new oe({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});r.setPosition(0,0,0),r.setHeading(0),this.scene.add(r.group);const g=this.createNameLabel(this.players.get(h).info.name);r.group.add(g),g.position.set(0,1.8,0),this.players.set(h,{...this.players.get(h),car:r,label:g})}),this.relineUpGrid(),this.audio=new Xe(this.camera),this.applySettingsToAudio();const n=J.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>n());const c=this.players.get(this.localId).car;this.chaseCamera.update(0,c.group),this.running=!0,this.clock.start(),this.loop(),t?this.countdownStartAt=t:this.countdownStartAt=Date.now()}update(t){var b,S;if(this.frozen)return;this.physics.update(t);const e=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const l=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(l)),l>=3&&(this.raceStarted=!0)}if(this.raceStarted){const l=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),d=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),I=this.input.isDown("Space"),x=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),k=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),M=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),D=F.clamp(k-M,-1,1);e.car.setInputs({throttle:l,brake:d,steering:D,handbrake:I,boost:x})}else e.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1});this.players.forEach(({car:l})=>l.update(t)),this.currentSpeed=e.car.getSpeed(),this.chaseCamera.update(t,e.car.group),this.track.update(e.car.group.position.z),(b=this.environment)==null||b.update(e.car.group.position.z);const s=this.camera.position;this.players.forEach(({car:l,label:d})=>{var P;if(!d)return;const I=s.distanceTo(l.group.position),x=8,M=F.clamp((I-x)/(45-x),0,1),D=F.lerp(1,.65,M),w=((P=d.userData)==null?void 0:P.baseScale)||{w:1.05,h:.35};d.scale.set(w.w*D,w.h*D,1);const y=d.material;y&&(y.opacity=F.lerp(1,.85,M))});const n=e.car.group.position,c=.6,h=1.2,r={minX:n.x-c,maxX:n.x+c,minZ:n.z-h,maxZ:n.z+h},g=e.car.getVelocityRef().clone();if(this.collision.resolve(n,e.car.getVelocityRef(),r)){const l=e.car.getVelocityRef(),d=g.clone().sub(l),I=F.clamp(d.length()*.1,0,1);(S=this.audio)==null||S.playCollision(I)}const m=25;if(Math.abs(n.x)>m&&(n.x=F.clamp(n.x,-m,m)),!this.winnerId){for(const[l,d]of this.players)if(d.car.group.position.z>=this.finishZ){this.winnerId=l;break}}}render(){this.renderSystem.render()}destroy(){var t;this.running=!1,this.clock.stop(),this.disposeBag.forEach(e=>e()),(t=this.environment)==null||t.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}resetForReplay(t){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(e=>{e.car.reset(new le(0,0,0),0)}),this.relineUpGrid(),this.countdownStartAt=t||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const t=this.players.get(this.localId),e=t.car.group.position,s=t.car.group.quaternion;return{p:[e.x,e.y,e.z],q:[s.x,s.y,s.z,s.w]}}applyRemoteTransform(t,e,s){const n=this.players.get(t);if(!n||t===this.localId)return;const c=new le(e[0],e[1],e[2]),h=new Ze(s[0],s[1],s[2],s[3]);n.car.group.position.lerp(c,.35),n.car.group.quaternion.slerp(h,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(t){if(this.players.has(t.id))return;const e=new oe({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});e.setPosition(0,0,0),e.setHeading(0),this.scene.add(e.group);const s=this.createNameLabel(t.name);e.group.add(s),s.position.set(0,1.8,0),this.players.set(t.id,{info:t,car:e,label:s}),this.raceStarted||this.relineUpGrid()}removePlayer(t){const e=this.players.get(t);if(e){try{this.scene.remove(e.car.group)}catch{}this.players.delete(t),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const t=[];return this.players.forEach((e,s)=>{t.push({id:s,name:e.info.name,z:e.car.group.position.z})}),t}relineUpGrid(){const t=Array.from(this.players.keys()),e=Math.min(3,Math.max(2,t.length)),s=2.5,n=4,c=0;t.forEach((h,r)=>{const g=Math.floor(r/e),T=r%e,b=-((e-1)*s)/2+T*s,S=c-g*n,l=this.players.get(h);l.car.setPosition(b,0,S),l.car.setHeading(0)})}applySettingsToAudio(){var e;const t=ne(J);(e=this.audio)==null||e.updateFromSettings(t)}createNameLabel(t){const e=document.createElement("canvas");e.width=256,e.height=96;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const n=18,c=e.width-n*2,h=56,r=12,g=12,T=n,m=(e.height-h-r)/2;let b=22;s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff";do{if(s.font=`700 ${b}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,s.measureText(t).width<=c-n||b<=13)break;b-=1}while(b>13);const S=(w,y,P,W,X)=>{const N=Math.min(X,W/2,P/2);s.beginPath(),s.moveTo(w+N,y),s.arcTo(w+P,y,w+P,y+W,N),s.arcTo(w+P,y+W,w,y+W,N),s.arcTo(w,y+W,w,y,N),s.arcTo(w,y,w+P,y,N),s.closePath()};s.save(),s.shadowColor="rgba(0,0,0,0.35)",s.shadowBlur=8,s.shadowOffsetY=2,S(T,m,c,h,g),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.restore();const l=T+c/2,d=m+h-1;s.beginPath(),s.moveTo(l-10,d),s.lineTo(l+10,d),s.lineTo(l,d+r),s.closePath(),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.lineWidth=1,s.strokeStyle="rgba(255,255,255,0.18)",S(T,m,c,h,g),s.stroke(),s.fillStyle="#fff",s.fillText(t,e.width/2,m+h/2);const I=new Be(e);I.minFilter=je;const x=new Oe({map:I,transparent:!0,depthTest:!0,depthWrite:!1}),k=new qe(x),M=1.05,D=.35;return k.scale.set(M,D,1),k.userData={...k.userData,baseScale:{w:M,h:D}},k}}class tt{constructor(t,e,s,n){i(this,"ws",null);i(this,"url");i(this,"roomId");i(this,"playerId");i(this,"name");i(this,"reconnectDelay",1e3);i(this,"handlers",[]);i(this,"closed",!1);this.url=t,this.roomId=e,this.playerId=s,this.name=n||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);if(!e||!e.t)return;this.emit(e)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(t){for(const e of this.handlers)try{e(t)}catch{}}close(){var t;this.closed=!0;try{(t=this.ws)==null||t.close()}catch{}}on(t){this.handlers.push(t)}send(t){var e;try{((e=this.ws)==null?void 0:e.readyState)===1&&this.ws.send(JSON.stringify(t))}catch{}}sendState(t,e){this.send({t:"state",p:t,q:e})}sendLeaderboard(t){this.send({t:"lb",list:t})}}var st=j('<div class="countdown svelte-lzoy4r"> </div>'),at=j('<div class="winner icon-text svelte-lzoy4r"><!> </div>'),rt=j('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),it=j('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),nt=j('<div class="game-root svelte-lzoy4r"></div> <div class="hud svelte-lzoy4r"><!> <div class="speed svelte-lzoy4r"> </div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function kt(_,t){ge(t,!1);const e=()=>Me(Pe,"$page",s),[s,n]=xe(),c=E();let h=E(null),r=E(null),g=E(3),T=E(0),m=E(null),b=E([]),S=E(!1),l,d=E(null);we(()=>{l=new De,f(d,null);const u=localStorage.getItem("playerName")||"Anonymous";a(h)&&(async()=>{var se,ae;let o=await l.fetchRoom(a(c));if(!o)try{await l.joinRoom(a(c),u),o=await l.fetchRoom(a(c))}catch{}if(!o){alert("Room not found or no longer available."),history.back();return}const v=l.getPlayerId();if(!!!((se=o.players)!=null&&se[v])&&o.status==="waiting")try{await l.joinRoom(a(c),u),o=await l.fetchRoom(a(c))||o}catch{}const R=Object.values(o.players||{}).map(p=>({id:p.id,name:p.name||"Anonymous",isLocal:p.id===v})),A="wss://public_game_ws.realbrain.cc";f(d,new tt(A,o.id,v,u)),a(d).connect(),f(r,new et(a(h),R));const V=typeof o.raceStartAt=="number"?o.raceStartAt:void 0;a(r).init(V);const K=setInterval(()=>{if(!a(r)||!a(d))return;const{p,q:H}=a(r).getLocalTransform();a(d).sendState(p,H)},66);(ae=a(d))==null||ae.on(p=>{if(a(r))if(p.t==="state")a(r).applyRemoteTransform(p.id,p.p,p.q);else if(p.t==="players"){const H=new Set(a(r).getPlayerIds()),O=new Set(p.list.map(z=>z.id));p.list.forEach(z=>{H.has(z.id)||a(r).addPlayer({id:z.id,name:z.name,isLocal:z.id===v})}),H.forEach(z=>{O.has(z)||a(r).removePlayer(z)})}else p.t==="lb"?f(b,p.list):p.t==="winner"?a(m)||(f(m,p.name||"Unknown"),a(r).freeze(),f(S,!0)):p.t==="restart"&&(f(m,null),f(S,!1),a(r).resetForReplay(p.startAt))});const ue=setInterval(()=>{var p,H,O;if(a(r)){f(g,a(r).getCountdown()),f(T,Math.round(a(r).currentSpeed*3.6));const z=a(r).getWinnerId();z&&!a(m)&&(f(m,((p=R.find(Z=>Z.id===z))==null?void 0:p.name)||"Unknown"),a(r).freeze(),(H=a(d))==null||H.send({t:"winner",id:z,name:a(m)}),f(S,!0));const re=a(r).getPlayerStates().sort((Z,Q)=>Q.z-Z.z).map((Z,Q)=>({...Z,rank:Q+1}));f(b,re),(O=a(d))==null||O.sendLeaderboard(re)}},100);k=l.subscribeToRoom(o.id,()=>{}),I=ue,x=K})()});let I=null,x=null,k=null;ye(()=>{var u,o;(u=a(r))==null||u.destroy(),f(r,null),I&&clearInterval(I),x&&clearInterval(x),k&&k(),(o=a(d))==null||o.close()}),ve(()=>e(),()=>{f(c,e().params.roomId)}),be(),Ae();var M=nt(),D=ee(M);Re(D,u=>f(h,u),()=>a(h));var w=U(D,2),y=$(w);{var P=u=>{var o=st(),v=$(o,!0);L(o),q(()=>B(v,a(g))),G(u,o)},W=u=>{var o=ce(),v=ee(o);{var C=R=>{var A=at(),V=$(A);Je(V,{size:20});var K=U(V);L(A),q(()=>B(K,` Winner: ${a(m)??""}`)),G(R,A)};Y(v,R=>{a(m)&&R(C)},!0)}G(u,o)};Y(y,u=>{a(g)>0?u(P):u(W,!1)})}var X=U(y,2),N=$(X);L(X);var te=U(X,2),de=U($(te),2);_e(de,1,()=>a(b),ke,(u,o)=>{var v=rt(),C=$(v),R=$(C);L(C);var A=U(C,2),V=$(A,!0);L(A),L(v),q(()=>{B(R,`${a(o),ie(()=>a(o).rank)??""}.`),B(V,(a(o),ie(()=>a(o).name)))}),G(u,v)}),L(te),L(w);var he=U(w,2);{var pe=u=>{var o=it(),v=$(o);L(o),ze("click",v,()=>{var R,A;const C=Date.now()+3e3;(R=a(d))==null||R.send({t:"restart",startAt:C}),(A=a(r))==null||A.resetForReplay(C),f(m,null),f(S,!1)}),G(u,o)};Y(he,u=>{a(m)&&a(S)&&u(pe)})}q(()=>B(N,`${a(T)??""} km/h`)),G(_,M),Se(),n()}export{kt as component};
