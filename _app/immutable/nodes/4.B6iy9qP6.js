var $e=Object.defineProperty;var Le=(T,e,t)=>e in T?$e(T,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):T[e]=t;var c=(T,e,t)=>Le(T,typeof e!="symbol"?e+"":e,t);import"../chunks/Bzak7iHL.js";import"../chunks/DLP-JChq.js";import{o as He,a as We}from"../chunks/D7t-Q6zm.js";import{aw as he,c as ee,j as U,p as Ue,l as Ne,b as Fe,f as Z,t as Q,i as ve,k as Ve,s as E,d as G,g as i,m as $,o as k,x as Oe,w as R,u as ye}from"../chunks/DmiIK6kV.js";import{g as ge,s as V}from"../chunks/B6u73DSu.js";import{l as xe,s as ze,i as re}from"../chunks/p4z5VYU4.js";import{I as Ie,e as Ze,f as qe}from"../chunks/B7T05OMM.js";import{s as be}from"../chunks/DNZA2biE.js";import{b as Xe}from"../chunks/CzH18Rhg.js";import{i as je}from"../chunks/CkuCw-0Z.js";import{s as Ye,a as Qe}from"../chunks/klbuo-dt.js";import{R as Je,p as Ke}from"../chunks/BeR0ha9p.js";import{S as et,P as tt,W as st,C as at,a as it,I as nt,R as rt,b as ot,c as lt,E as ct,T as ht,d as dt,e as Se,A as pt,M as W,V as J,Q as ut,f as oe,L as ft,g as mt,h as wt,G as vt,i as le,B as Me,j as K,k as yt,l as ke,D as gt,m as bt}from"../chunks/B6851Meq.js";import{s as ce}from"../chunks/DK_VGh2L.js";import{b as St}from"../chunks/B8plIoDJ.js";import{s as _e}from"../chunks/D2y1D9hg.js";function Mt(T,e){const t=xe(e,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}]];Ie(T,ze({name:"house"},()=>t,{get iconNode(){return s},children:(a,r)=>{var h=he(),n=ee(h);_e(n,e,"default",{}),U(a,h)},$$slots:{default:!0}}))}function kt(T,e){const t=xe(e,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"}],["path",{d:"M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"}],["path",{d:"M18 9h1.5a1 1 0 0 0 0-5H18"}],["path",{d:"M4 22h16"}],["path",{d:"M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"}],["path",{d:"M6 9H4.5a1 1 0 0 1 0-5H6"}]];Ie(T,ze({name:"trophy"},()=>t,{get iconNode(){return s},children:(a,r)=>{var h=he(),n=ee(h);_e(n,e,"default",{}),U(a,h)},$$slots:{default:!0}}))}class xt{constructor(e,t){c(this,"scene");c(this,"camera");c(this,"renderer");c(this,"clock");c(this,"physics");c(this,"input");c(this,"renderSystem");c(this,"chaseCamera");c(this,"environment");c(this,"track");c(this,"audio");c(this,"collision");c(this,"running",!1);c(this,"disposeBag",[]);c(this,"frameTimeBuffer",[]);c(this,"frameTimeBufferSize",5);c(this,"players",new Map);c(this,"localId");c(this,"countdown",3);c(this,"countdownStartAt",null);c(this,"raceStarted",!1);c(this,"finishZ",600);c(this,"winnerId",null);c(this,"frozen",!1);c(this,"finishGate");c(this,"finishGateBannerMat");c(this,"throttleInput",0);c(this,"muted",!1);c(this,"currentSpeed",0);c(this,"loop",()=>{if(!this.running)return;const e=this.clock.getDelta(),t=Math.min(e,.1);this.frameTimeBuffer.push(t),this.frameTimeBuffer.length>this.frameTimeBufferSize&&this.frameTimeBuffer.shift();const s=this.frameTimeBuffer.reduce((a,r)=>a+r,0)/this.frameTimeBuffer.length;this.update(s),this.render(),requestAnimationFrame(this.loop)});c(this,"updateSize",()=>{const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderSystem.updateSize&&this.renderSystem.updateSize(e,t)});var a;this.container=e,this.scene=new et,this.camera=new tt(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new st({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new at,this.physics=new it,this.input=new nt(e),this.renderSystem=new rt(this.scene,this.camera,this.renderer),this.chaseCamera=new ot(this.camera);const s=t.find(r=>r.isLocal);this.localId=s?s.id:(a=t[0])==null?void 0:a.id,t.forEach(r=>{this.players.set(r.id,{info:r,car:null,label:null})})}init(e){const t=ge(ce);this.renderer.setPixelRatio(Math.min(devicePixelRatio,t.graphics.resolution)),this.renderer.shadowMap.enabled=!!t.graphics.shadows,this.renderer.shadowMap.type=lt,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new ct(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new ht,this.scene.add(this.track.group),this.collision=new dt(this.track.obstacles),this.createOrUpdateFinishGate(),Array.from(this.players.keys()).forEach(d=>{const w=new Se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});w.setPosition(0,0,0),w.setHeading(0),this.scene.add(w.group);const p=this.createNameLabel(this.players.get(d).info.name);w.group.add(p),p.position.set(0,1.8,0),this.players.set(d,{...this.players.get(d),car:w,label:p})}),this.relineUpGrid(),this.audio=new pt(this.camera),this.applySettingsToAudio();const a=ce.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>a());const r=async()=>{var d;await((d=this.audio)==null?void 0:d.resume()),window.removeEventListener("keydown",r,!0),window.removeEventListener("pointerdown",r,!0),this.disposeBag=this.disposeBag.filter(w=>w!==h)},h=()=>{window.removeEventListener("keydown",r,!0),window.removeEventListener("pointerdown",r,!0)};window.addEventListener("keydown",r,!0),window.addEventListener("pointerdown",r,!0),this.disposeBag.push(h);const n=this.players.get(this.localId).car;this.chaseCamera.update(0,n.group),this.running=!0,this.clock.start(),this.loop(),e?this.countdownStartAt=e:this.countdownStartAt=Date.now()}update(e){var S,y,v;if(this.frozen)return;this.physics.update(e);const t=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const l=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(l)),l>=3&&(this.raceStarted=!0)}if(this.raceStarted){const l=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),f=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),x=this.input.isDown("Space"),M=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),z=W.clamp(this.input.getSteerValue(),-1,1);t.car.setInputs({throttle:l,brake:f,steering:z,handbrake:x,boost:M}),this.throttleInput=l}else t.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1}),this.throttleInput=0;if(this.players.forEach(({car:l})=>l.update(e)),this.currentSpeed=t.car.getSpeed(),this.chaseCamera.update(e,t.car.group),this.resolveLocalCarCollisions(),(S=this.audio)==null||S.setEngine(this.throttleInput,this.currentSpeed,t.car.config.maxSpeed),this.track.update(t.car.group.position.z),(y=this.environment)==null||y.update(t.car.group.position.z),this.finishGate&&this.finishGateBannerMat){const l=this.finishZ-t.car.group.position.z;if(l<=0)this.finishGateBannerMat.opacity=1,this.finishGate.visible=!0;else if(l<160){const f=1-l/160;this.finishGateBannerMat.opacity=W.clamp(.12+.88*f,.12,1),this.finishGate.visible=!0}else this.finishGateBannerMat.opacity=.12,this.finishGate.visible=!1}const s=this.camera.position;this.players.forEach(({car:l,label:f})=>{var D;if(!f)return;const x=s.distanceTo(l.group.position),M=8,g=W.clamp((x-M)/(45-M),0,1),I=W.lerp(1,.65,g),_=((D=f.userData)==null?void 0:D.baseScale)||{w:1.05,h:.35};f.scale.set(_.w*I,_.h*I,1);const A=f.material;A&&(A.opacity=W.lerp(1,.85,g))});const a=t.car.group.position,r=.6,h=1.2,n={minX:a.x-r,maxX:a.x+r,minZ:a.z-h,maxZ:a.z+h},d=t.car.getVelocityRef().clone();if(this.collision.resolve(a,t.car.getVelocityRef(),n)){const l=t.car.getVelocityRef(),f=d.clone().sub(l),x=W.clamp(f.length()*.1,0,1);(v=this.audio)==null||v.playCollision(x)}const p=25;if(Math.abs(a.x)>p&&(a.x=W.clamp(a.x,-p,p)),!this.winnerId){for(const[l,f]of this.players)if(f.car.group.position.z>=this.finishZ){this.winnerId=l;break}}}render(){this.renderSystem.render()}resolveLocalCarCollisions(){var w;const e=this.players.get(this.localId);if(!e)return;const t=e.car.group.position,s=e.car.getVelocityRef(),r=.7*2,h=r*r,n=new J;let d=0;if(this.players.forEach((p,S)=>{if(S===this.localId)return;const y=p.car.group.position;n.copy(y).sub(t);const v=n.x,l=n.z,f=v*v+l*l;if(f>0&&f<h){const x=Math.sqrt(f)||1e-6,M=new J(v/x,0,l/x),z=r-x;t.addScaledVector(M,-z);const g=s.dot(M);g>0&&(s.addScaledVector(M,-1.2*g),d+=Math.abs(g))}}),d>0){const p=W.clamp(d*.15,0,1);(w=this.audio)==null||w.playCollision(p)}}destroy(){var e,t;this.running=!1,this.clock.stop(),this.disposeBag.forEach(s=>s()),(e=this.environment)==null||e.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),(t=this.audio)==null||t.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}setMuted(e){this.muted=e,this.applySettingsToAudio()}resetForReplay(e){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(t=>{t.car.reset(new J(0,0,0),0)}),this.relineUpGrid(),this.finishGate&&this.finishGateBannerMat&&(this.finishGate.position.set(0,0,this.finishZ),this.finishGate.visible=!1,this.finishGateBannerMat.opacity=.12),this.countdownStartAt=e||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const e=this.players.get(this.localId),t=e.car.group.position,s=e.car.group.quaternion;return{p:[t.x,t.y,t.z],q:[s.x,s.y,s.z,s.w]}}applyRemoteTransform(e,t,s){const a=this.players.get(e);if(!a||e===this.localId)return;const r=new J(t[0],t[1],t[2]),h=new ut(s[0],s[1],s[2],s[3]);a.car.group.position.lerp(r,.35),a.car.group.quaternion.slerp(h,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(e){if(this.players.has(e.id))return;const t=new Se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});t.setPosition(0,0,0),t.setHeading(0),this.scene.add(t.group);const s=this.createNameLabel(e.name);t.group.add(s),s.position.set(0,1.8,0),this.players.set(e.id,{info:e,car:t,label:s}),this.raceStarted||this.relineUpGrid()}removePlayer(e){const t=this.players.get(e);if(t){try{this.scene.remove(t.car.group)}catch{}this.players.delete(e),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const e=[];return this.players.forEach((t,s)=>{e.push({id:s,name:t.info.name,z:t.car.group.position.z})}),e}relineUpGrid(){const e=Array.from(this.players.keys()),s=Math.min(4,Math.max(2,Math.ceil(Math.sqrt(e.length)))),a=2.8,r=5.4,h=-8;e.forEach((n,d)=>{const w=Math.floor(d/s),p=d%s,y=-((s-1)*a)/2+p*a,v=h-w*r-(w%2?.6:0),l=this.players.get(n);l.car.setPosition(y,0,v),l.car.setHeading(0)})}applySettingsToAudio(){const e=ge(ce);this.audio&&(this.muted?this.audio.updateFromSettings({audio:{master:0,engine:e.audio.engine,effects:e.audio.effects,music:e.audio.music,spatial:e.audio.spatial}}):this.audio.updateFromSettings(e))}createNameLabel(e){const t=document.createElement("canvas");t.width=256,t.height=96;const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const a=18,r=t.width-a*2,h=56,n=12,d=12,w=a,p=(t.height-h-n)/2;let S=22;s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff";do{if(s.font=`700 ${S}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,s.measureText(e).width<=r-a||S<=13)break;S-=1}while(S>13);const y=(I,_,A,D,q)=>{const H=Math.min(q,D/2,A/2);s.beginPath(),s.moveTo(I+H,_),s.arcTo(I+A,_,I+A,_+D,H),s.arcTo(I+A,_+D,I,_+D,H),s.arcTo(I,_+D,I,_,H),s.arcTo(I,_,I+A,_,H),s.closePath()};s.save(),s.shadowColor="rgba(0,0,0,0.35)",s.shadowBlur=8,s.shadowOffsetY=2,y(w,p,r,h,d),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.restore();const v=w+r/2,l=p+h-1;s.beginPath(),s.moveTo(v-10,l),s.lineTo(v+10,l),s.lineTo(v,l+n),s.closePath(),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.lineWidth=1,s.strokeStyle="rgba(255,255,255,0.18)",y(w,p,r,h,d),s.stroke(),s.fillStyle="#fff",s.fillText(e,t.width/2,p+h/2);const f=new oe(t);f.minFilter=ft;const x=new mt({map:f,transparent:!0,depthTest:!0,depthWrite:!1}),M=new wt(x),z=1.05,g=.35;return M.scale.set(z,g,1),M.userData={...M.userData,baseScale:{w:z,h:g}},M}createOrUpdateFinishGate(){const e=new vt,t=new le({color:2237994}),s=new le({color:2764596}),a=12,r=.6,h=.8,n=4.2,d=.5,w=.7,p=new Me(r,n,h),S=new K(p,t),y=new K(p,t);S.position.set(-a,n/2,0),y.position.set(a,n/2,0),e.add(S,y);const v=new Me(a*2+r,d,w),l=new K(v,s);l.position.set(0,n+d/2,0),e.add(l);const f=a*2-2,x=1.8,M=new yt(f,x);if(this.finishGateBannerMat){const g=this.makeFinishBannerTexture(20,4);g.wrapS=g.wrapT=ke,g.needsUpdate=!0,this.finishGateBannerMat.map=g,this.finishGateBannerMat.needsUpdate=!0}else{const g=this.makeFinishBannerTexture(20,4);g.wrapS=g.wrapT=ke,g.needsUpdate=!0,this.finishGateBannerMat=new le({map:g,transparent:!0,opacity:.12,depthWrite:!1,side:gt})}const z=new K(M,this.finishGateBannerMat);if(z.rotation.y=Math.PI,z.position.set(0,n-x/2,0),e.add(z),e.position.set(0,0,this.finishZ),e.visible=!1,this.finishGate)try{this.scene.remove(this.finishGate)}catch{}this.finishGate=e,this.scene.add(e)}makeCheckerTexture(e=8,t=2){const s=document.createElement("canvas");s.width=512,s.height=64;const a=s.getContext("2d"),r=s.width/e,h=s.height/t;for(let n=0;n<t;n++)for(let d=0;d<e;d++){const w=(n+d)%2===0;a.fillStyle=w?"#111":"#eee",a.fillRect(d*r,n*h,r,h)}return new oe(s)}makeFinishBannerTexture(e=20,t=4){const s=document.createElement("canvas");s.width=1024,s.height=256;const a=s.getContext("2d"),r=s.width/e,h=s.height/t;for(let y=0;y<t;y++)for(let v=0;v<e;v++){const l=(y+v)%2===0;a.fillStyle=l?"#111":"#eee",a.fillRect(v*r,y*h,r,h)}a.fillStyle="rgba(0,0,0,0.18)",a.fillRect(0,0,s.width,s.height);const n="FINISH";let d=180;const w=40;a.textAlign="center",a.textBaseline="middle";do{if(a.font=`900 ${d}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,a.measureText(n).width<=s.width-w*2||d<=72)break;d-=4}while(d>72);a.save(),a.shadowColor="rgba(0,0,0,0.6)",a.shadowBlur=8,a.shadowOffsetY=4,a.lineWidth=Math.max(6,Math.floor(d*.06)),a.strokeStyle="rgba(0,0,0,0.9)",a.fillStyle="#ffffff";const p=s.width/2,S=s.height/2+6;return a.strokeText(n,p,S),a.fillText(n,p,S),a.restore(),new oe(s)}}class zt{constructor(e,t,s,a){c(this,"ws",null);c(this,"url");c(this,"roomId");c(this,"playerId");c(this,"name");c(this,"reconnectDelay",1e3);c(this,"handlers",[]);c(this,"closed",!1);this.url=e,this.roomId=t,this.playerId=s,this.name=a||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);if(!t||!t.t)return;this.emit(t)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(e){for(const t of this.handlers)try{t(e)}catch{}}close(){var e;this.closed=!0;try{(e=this.ws)==null||e.close()}catch{}}on(e){this.handlers.push(e)}send(e){var t;try{((t=this.ws)==null?void 0:t.readyState)===1&&this.ws.send(JSON.stringify(e))}catch{}}sendState(e,t){this.send({t:"state",p:e,q:t})}sendLeaderboard(e){this.send({t:"lb",list:e})}}var It=Z('<div class="countdown svelte-lzoy4r"> </div>'),_t=Z('<div class="winner icon-text svelte-lzoy4r"><!> </div>'),Tt=Z('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),Bt=Z('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),Gt=Z('<div class="game-root svelte-lzoy4r"></div> <!> <div class="hud svelte-lzoy4r"><a class="home-btn svelte-lzoy4r" aria-label="Home" title="Home" style="pointer-events:auto"><!> <span>Home</span></a> <!> <div class="speed svelte-lzoy4r"> </div> <div class="audio-controls svelte-lzoy4r" style="pointer-events:auto"><button class="mute-btn svelte-lzoy4r"> </button></div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function jt(T,e){Ue(e,!1);const t=()=>Qe(Ke,"$page",s),[s,a]=Ye(),r=$();let h=$(null),n=$(null),d=$(3),w=$(0),p=$(null),S=$([]),y=$(!1),v=$(!1),l,f=$(null);He(()=>{l=new Je,k(f,null);const u=localStorage.getItem("playerName")||"Anonymous";i(h)&&(async()=>{var fe,me;let o=await l.fetchRoom(i(r));if(!o)try{await l.joinRoom(i(r),u),o=await l.fetchRoom(i(r))}catch{}if(!o){alert("Room not found or no longer available."),history.back();return}const m=l.getPlayerId();if(!!!((fe=o.players)!=null&&fe[m])&&o.status==="waiting")try{await l.joinRoom(i(r),u),o=await l.fetchRoom(i(r))||o}catch{}const C=Object.values(o.players||{}).map(b=>({id:b.id,name:b.name||"Anonymous",isLocal:b.id===m})),P="wss://public_game_ws.realbrain.cc";k(f,new zt(P,o.id,m,u)),i(f).connect(),k(n,new xt(i(h),C));const F=typeof o.raceStartAt=="number"?o.raceStartAt:void 0;i(n).init(F);const ie=setInterval(()=>{if(!i(n)||!i(f))return;const{p:b,q:N}=i(n).getLocalTransform();i(f).sendState(b,N)},66);(me=i(f))==null||me.on(b=>{if(i(n))if(b.t==="state")i(n).applyRemoteTransform(b.id,b.p,b.q);else if(b.t==="players"){const N=new Set(i(n).getPlayerIds()),Y=new Set(b.list.map(B=>B.id));b.list.forEach(B=>{N.has(B.id)||i(n).addPlayer({id:B.id,name:B.name,isLocal:B.id===m})}),N.forEach(B=>{Y.has(B)||i(n).removePlayer(B)})}else b.t==="lb"?k(S,b.list):b.t==="winner"?i(p)||(k(p,b.name||"Unknown"),k(y,!0)):b.t==="restart"&&(k(p,null),k(y,!1),i(n).resetForReplay(b.startAt))});const Ee=setInterval(()=>{var b,N,Y;if(i(n)){k(d,i(n).getCountdown()),k(w,Math.round(i(n).currentSpeed*3.6));const B=i(n).getWinnerId();B&&!i(p)&&(k(p,((b=C.find(O=>O.id===B))==null?void 0:b.name)||"Unknown"),(N=i(f))==null||N.send({t:"winner",id:B,name:i(p)}),k(y,!0));const we=i(n).getPlayerStates().sort((O,ne)=>ne.z-O.z).map((O,ne)=>({...O,rank:ne+1}));k(S,we),(Y=i(f))==null||Y.sendLeaderboard(we)}},100);z=l.subscribeToRoom(o.id,()=>{}),x=Ee,M=ie})()});let x=null,M=null,z=null;We(()=>{var u,o;(u=i(n))==null||u.destroy(),k(n,null),x&&clearInterval(x),M&&clearInterval(M),z&&z(),(o=i(f))==null||o.close()});function g(u){var o,m;(m=(o=i(n))==null?void 0:o.input)==null||m.setMobileThrottle(u)}function I(u){var o,m;(m=(o=i(n))==null?void 0:o.input)==null||m.setMobileBrake(u)}function _(u){var o,m;(m=(o=i(n))==null?void 0:o.input)==null||m.setMobileSteer(u)}function A(u){var o,m;(m=(o=i(n))==null?void 0:o.input)==null||m.setMobileHandbrake(u)}function D(u){var o,m;(m=(o=i(n))==null?void 0:o.input)==null||m.setMobileBoost(u)}Ne(()=>t(),()=>{k(r,t().params.roomId)}),Fe(),je();var q=Gt(),H=ee(q);Xe(H,u=>k(h,u),()=>i(h));var de=E(H,2);bt(de,{onThrottle:g,onBrake:I,onSteer:_,onHandbrake:A,onBoost:D});var te=E(de,2),X=G(te),Te=G(X);Mt(Te,{size:18}),Oe(2),R(X);var pe=E(X,2);{var Be=u=>{var o=It(),m=G(o,!0);R(o),Q(()=>V(m,i(d))),U(u,o)},Ge=u=>{var o=he(),m=ee(o);{var L=C=>{var P=_t(),F=G(P);kt(F,{size:20});var ie=E(F);R(P),Q(()=>V(ie,` Winner: ${i(p)??""}`)),U(C,P)};re(m,C=>{i(p)&&C(L)},!0)}U(u,o)};re(pe,u=>{i(d)>0?u(Be):u(Ge,!1)})}var se=E(pe,2),Re=G(se);R(se);var ae=E(se,2),j=G(ae),Ce=G(j,!0);R(j),R(ae);var ue=E(ae,2),Pe=E(G(ue),2);Ze(Pe,1,()=>i(S),qe,(u,o)=>{var m=Tt(),L=G(m),C=G(L);R(L);var P=E(L,2),F=G(P,!0);R(P),R(m),Q(()=>{V(C,`${i(o),ye(()=>i(o).rank)??""}.`),V(F,(i(o),ye(()=>i(o).name)))}),U(u,m)}),R(ue),R(te);var Ae=E(te,2);{var De=u=>{var o=Bt(),m=G(o);R(o),ve("click",m,()=>{var C,P;const L=Date.now()+3e3;(C=i(f))==null||C.send({t:"restart",startAt:L}),(P=i(n))==null||P.resetForReplay(L),k(p,null),k(y,!1)}),U(u,o)};re(Ae,u=>{i(p)&&i(y)&&u(De)})}Q(()=>{be(X,"href",`${St}/`),V(Re,`${i(w)??""} km/h`),be(j,"aria-pressed",i(v)),V(Ce,i(v)?"Unmute":"Mute")}),ve("click",j,()=>{var u;k(v,!i(v)),(u=i(n))==null||u.setMuted(i(v))}),U(T,q),Ve(),a()}export{jt as component};
