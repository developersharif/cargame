var Bt=Object.defineProperty;var Dt=(T,t,e)=>t in T?Bt(T,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):T[t]=e;var c=(T,t,e)=>Dt(T,typeof t!="symbol"?t+"":t,e);import"../chunks/Bzak7iHL.js";import"../chunks/Czc6yBml.js";import{o as At,a as Ct}from"../chunks/CKvlG_S6.js";import{aw as ct,W as J,_ as H,O as Pt,Q as $t,R as Et,T as Z,X as Y,Z as ut,$ as Lt,Y as B,d as M,a0 as $,b as i,V as L,a4 as Wt,a3 as D,u as ft}from"../chunks/Cidz_ldb.js";import{g as mt,s as V}from"../chunks/D2ksQ1WS.js";import{i as it}from"../chunks/ChKw7TTJ.js";import{I as bt,e as Ht,f as Nt}from"../chunks/CqxE3brQ.js";import{s as wt}from"../chunks/tJQPi215.js";import{b as Ut}from"../chunks/wvln4aAB.js";import{i as Ft}from"../chunks/SXciGwAh.js";import{s as Vt,a as Ot}from"../chunks/kEFeLsGo.js";import{R as Zt,p as Xt}from"../chunks/D2TRGzlB.js";import{S as qt,P as jt,W as Yt,C as Kt,a as Qt,I as Jt,R as te,b as ee,c as se,E as ae,T as ie,d as ne,e as vt,A as re,M as W,V as K,Q as oe,f as nt,L as ce,g as le,h as he,G as de,i as rt,B as yt,j as Q,k as pe,l as gt,D as ue}from"../chunks/IRFdlqmu.js";import{s as ot}from"../chunks/Ch-va3tc.js";import{b as fe}from"../chunks/DLl0oy-k.js";import{s as St}from"../chunks/Cof14SmM.js";import{l as Mt,s as xt}from"../chunks/9ASGDRHX.js";function me(T,t){const e=Mt(t,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}]];bt(T,xt({name:"house"},()=>e,{get iconNode(){return s},children:(a,r)=>{var l=ct(),n=J(l);St(n,t,"default",{}),H(a,l)},$$slots:{default:!0}}))}function we(T,t){const e=Mt(t,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"}],["path",{d:"M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"}],["path",{d:"M18 9h1.5a1 1 0 0 0 0-5H18"}],["path",{d:"M4 22h16"}],["path",{d:"M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"}],["path",{d:"M6 9H4.5a1 1 0 0 1 0-5H6"}]];bt(T,xt({name:"trophy"},()=>e,{get iconNode(){return s},children:(a,r)=>{var l=ct(),n=J(l);St(n,t,"default",{}),H(a,l)},$$slots:{default:!0}}))}class ve{constructor(t,e){c(this,"scene");c(this,"camera");c(this,"renderer");c(this,"clock");c(this,"physics");c(this,"input");c(this,"renderSystem");c(this,"chaseCamera");c(this,"environment");c(this,"track");c(this,"audio");c(this,"collision");c(this,"running",!1);c(this,"disposeBag",[]);c(this,"frameTimeBuffer",[]);c(this,"frameTimeBufferSize",5);c(this,"players",new Map);c(this,"localId");c(this,"countdown",3);c(this,"countdownStartAt",null);c(this,"raceStarted",!1);c(this,"finishZ",600);c(this,"winnerId",null);c(this,"frozen",!1);c(this,"finishGate");c(this,"finishGateBannerMat");c(this,"throttleInput",0);c(this,"muted",!1);c(this,"currentSpeed",0);c(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta(),e=Math.min(t,.1);this.frameTimeBuffer.push(e),this.frameTimeBuffer.length>this.frameTimeBufferSize&&this.frameTimeBuffer.shift();const s=this.frameTimeBuffer.reduce((a,r)=>a+r,0)/this.frameTimeBuffer.length;this.update(s),this.render(),requestAnimationFrame(this.loop)});c(this,"updateSize",()=>{const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderSystem.updateSize&&this.renderSystem.updateSize(t,e)});var a;this.container=t,this.scene=new qt,this.camera=new jt(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new Yt({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Kt,this.physics=new Qt,this.input=new Jt(t),this.renderSystem=new te(this.scene,this.camera,this.renderer),this.chaseCamera=new ee(this.camera);const s=e.find(r=>r.isLocal);this.localId=s?s.id:(a=e[0])==null?void 0:a.id,e.forEach(r=>{this.players.set(r.id,{info:r,car:null,label:null})})}init(t){const e=mt(ot);this.renderer.setPixelRatio(Math.min(devicePixelRatio,e.graphics.resolution)),this.renderer.shadowMap.enabled=!!e.graphics.shadows,this.renderer.shadowMap.type=se,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new ae(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new ie,this.scene.add(this.track.group),this.collision=new ne(this.track.obstacles),this.createOrUpdateFinishGate(),Array.from(this.players.keys()).forEach(h=>{const f=new vt({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});f.setPosition(0,0,0),f.setHeading(0),this.scene.add(f.group);const d=this.createNameLabel(this.players.get(h).info.name);f.group.add(d),d.position.set(0,1.8,0),this.players.set(h,{...this.players.get(h),car:f,label:d})}),this.relineUpGrid(),this.audio=new re(this.camera),this.applySettingsToAudio();const a=ot.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>a());const r=async()=>{var h;await((h=this.audio)==null?void 0:h.resume()),window.removeEventListener("keydown",r,!0),window.removeEventListener("pointerdown",r,!0),this.disposeBag=this.disposeBag.filter(f=>f!==l)},l=()=>{window.removeEventListener("keydown",r,!0),window.removeEventListener("pointerdown",r,!0)};window.addEventListener("keydown",r,!0),window.addEventListener("pointerdown",r,!0),this.disposeBag.push(l);const n=this.players.get(this.localId).car;this.chaseCamera.update(0,n.group),this.running=!0,this.clock.start(),this.loop(),t?this.countdownStartAt=t:this.countdownStartAt=Date.now()}update(t){var b,v,m;if(this.frozen)return;this.physics.update(t);const e=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const o=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(o)),o>=3&&(this.raceStarted=!0)}if(this.raceStarted){const o=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),p=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),x=this.input.isDown("Space"),S=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),k=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),w=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),z=W.clamp(k-w,-1,1);e.car.setInputs({throttle:o,brake:p,steering:z,handbrake:x,boost:S}),this.throttleInput=o}else e.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1}),this.throttleInput=0;if(this.players.forEach(({car:o})=>o.update(t)),this.currentSpeed=e.car.getSpeed(),this.chaseCamera.update(t,e.car.group),this.resolveLocalCarCollisions(),(b=this.audio)==null||b.setEngine(this.throttleInput,this.currentSpeed,e.car.config.maxSpeed),this.track.update(e.car.group.position.z),(v=this.environment)==null||v.update(e.car.group.position.z),this.finishGate&&this.finishGateBannerMat){const o=this.finishZ-e.car.group.position.z;if(o<=0)this.finishGateBannerMat.opacity=1,this.finishGate.visible=!0;else if(o<160){const p=1-o/160;this.finishGateBannerMat.opacity=W.clamp(.12+.88*p,.12,1),this.finishGate.visible=!0}else this.finishGateBannerMat.opacity=.12,this.finishGate.visible=!1}const s=this.camera.position;this.players.forEach(({car:o,label:p})=>{var P;if(!p)return;const x=s.distanceTo(o.group.position),S=8,w=W.clamp((x-S)/(45-S),0,1),z=W.lerp(1,.65,w),I=((P=p.userData)==null?void 0:P.baseScale)||{w:1.05,h:.35};p.scale.set(I.w*z,I.h*z,1);const R=p.material;R&&(R.opacity=W.lerp(1,.85,w))});const a=e.car.group.position,r=.6,l=1.2,n={minX:a.x-r,maxX:a.x+r,minZ:a.z-l,maxZ:a.z+l},h=e.car.getVelocityRef().clone();if(this.collision.resolve(a,e.car.getVelocityRef(),n)){const o=e.car.getVelocityRef(),p=h.clone().sub(o),x=W.clamp(p.length()*.1,0,1);(m=this.audio)==null||m.playCollision(x)}const d=25;if(Math.abs(a.x)>d&&(a.x=W.clamp(a.x,-d,d)),!this.winnerId){for(const[o,p]of this.players)if(p.car.group.position.z>=this.finishZ){this.winnerId=o;break}}}render(){this.renderSystem.render()}resolveLocalCarCollisions(){var f;const t=this.players.get(this.localId);if(!t)return;const e=t.car.group.position,s=t.car.getVelocityRef(),r=.7*2,l=r*r,n=new K;let h=0;if(this.players.forEach((d,b)=>{if(b===this.localId)return;const v=d.car.group.position;n.copy(v).sub(e);const m=n.x,o=n.z,p=m*m+o*o;if(p>0&&p<l){const x=Math.sqrt(p)||1e-6,S=new K(m/x,0,o/x),k=r-x;e.addScaledVector(S,-k);const w=s.dot(S);w>0&&(s.addScaledVector(S,-1.2*w),h+=Math.abs(w))}}),h>0){const d=W.clamp(h*.15,0,1);(f=this.audio)==null||f.playCollision(d)}}destroy(){var t,e;this.running=!1,this.clock.stop(),this.disposeBag.forEach(s=>s()),(t=this.environment)==null||t.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),(e=this.audio)==null||e.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}setMuted(t){this.muted=t,this.applySettingsToAudio()}resetForReplay(t){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(e=>{e.car.reset(new K(0,0,0),0)}),this.relineUpGrid(),this.finishGate&&this.finishGateBannerMat&&(this.finishGate.position.set(0,0,this.finishZ),this.finishGate.visible=!1,this.finishGateBannerMat.opacity=.12),this.countdownStartAt=t||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const t=this.players.get(this.localId),e=t.car.group.position,s=t.car.group.quaternion;return{p:[e.x,e.y,e.z],q:[s.x,s.y,s.z,s.w]}}applyRemoteTransform(t,e,s){const a=this.players.get(t);if(!a||t===this.localId)return;const r=new K(e[0],e[1],e[2]),l=new oe(s[0],s[1],s[2],s[3]);a.car.group.position.lerp(r,.35),a.car.group.quaternion.slerp(l,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(t){if(this.players.has(t.id))return;const e=new vt({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});e.setPosition(0,0,0),e.setHeading(0),this.scene.add(e.group);const s=this.createNameLabel(t.name);e.group.add(s),s.position.set(0,1.8,0),this.players.set(t.id,{info:t,car:e,label:s}),this.raceStarted||this.relineUpGrid()}removePlayer(t){const e=this.players.get(t);if(e){try{this.scene.remove(e.car.group)}catch{}this.players.delete(t),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const t=[];return this.players.forEach((e,s)=>{t.push({id:s,name:e.info.name,z:e.car.group.position.z})}),t}relineUpGrid(){const t=Array.from(this.players.keys()),s=Math.min(4,Math.max(2,Math.ceil(Math.sqrt(t.length)))),a=2.8,r=5.4,l=-8;t.forEach((n,h)=>{const f=Math.floor(h/s),d=h%s,v=-((s-1)*a)/2+d*a,m=l-f*r-(f%2?.6:0),o=this.players.get(n);o.car.setPosition(v,0,m),o.car.setHeading(0)})}applySettingsToAudio(){const t=mt(ot);this.audio&&(this.muted?this.audio.updateFromSettings({audio:{master:0,engine:t.audio.engine,effects:t.audio.effects,music:t.audio.music,spatial:t.audio.spatial}}):this.audio.updateFromSettings(t))}createNameLabel(t){const e=document.createElement("canvas");e.width=256,e.height=96;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const a=18,r=e.width-a*2,l=56,n=12,h=12,f=a,d=(e.height-l-n)/2;let b=22;s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff";do{if(s.font=`700 ${b}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,s.measureText(t).width<=r-a||b<=13)break;b-=1}while(b>13);const v=(z,I,R,P,X)=>{const N=Math.min(X,P/2,R/2);s.beginPath(),s.moveTo(z+N,I),s.arcTo(z+R,I,z+R,I+P,N),s.arcTo(z+R,I+P,z,I+P,N),s.arcTo(z,I+P,z,I,N),s.arcTo(z,I,z+R,I,N),s.closePath()};s.save(),s.shadowColor="rgba(0,0,0,0.35)",s.shadowBlur=8,s.shadowOffsetY=2,v(f,d,r,l,h),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.restore();const m=f+r/2,o=d+l-1;s.beginPath(),s.moveTo(m-10,o),s.lineTo(m+10,o),s.lineTo(m,o+n),s.closePath(),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.lineWidth=1,s.strokeStyle="rgba(255,255,255,0.18)",v(f,d,r,l,h),s.stroke(),s.fillStyle="#fff",s.fillText(t,e.width/2,d+l/2);const p=new nt(e);p.minFilter=ce;const x=new le({map:p,transparent:!0,depthTest:!0,depthWrite:!1}),S=new he(x),k=1.05,w=.35;return S.scale.set(k,w,1),S.userData={...S.userData,baseScale:{w:k,h:w}},S}createOrUpdateFinishGate(){const t=new de,e=new rt({color:2237994}),s=new rt({color:2764596}),a=12,r=.6,l=.8,n=4.2,h=.5,f=.7,d=new yt(r,n,l),b=new Q(d,e),v=new Q(d,e);b.position.set(-a,n/2,0),v.position.set(a,n/2,0),t.add(b,v);const m=new yt(a*2+r,h,f),o=new Q(m,s);o.position.set(0,n+h/2,0),t.add(o);const p=a*2-2,x=1.8,S=new pe(p,x);if(this.finishGateBannerMat){const w=this.makeFinishBannerTexture(20,4);w.wrapS=w.wrapT=gt,w.needsUpdate=!0,this.finishGateBannerMat.map=w,this.finishGateBannerMat.needsUpdate=!0}else{const w=this.makeFinishBannerTexture(20,4);w.wrapS=w.wrapT=gt,w.needsUpdate=!0,this.finishGateBannerMat=new rt({map:w,transparent:!0,opacity:.12,depthWrite:!1,side:ue})}const k=new Q(S,this.finishGateBannerMat);if(k.rotation.y=Math.PI,k.position.set(0,n-x/2,0),t.add(k),t.position.set(0,0,this.finishZ),t.visible=!1,this.finishGate)try{this.scene.remove(this.finishGate)}catch{}this.finishGate=t,this.scene.add(t)}makeCheckerTexture(t=8,e=2){const s=document.createElement("canvas");s.width=512,s.height=64;const a=s.getContext("2d"),r=s.width/t,l=s.height/e;for(let n=0;n<e;n++)for(let h=0;h<t;h++){const f=(n+h)%2===0;a.fillStyle=f?"#111":"#eee",a.fillRect(h*r,n*l,r,l)}return new nt(s)}makeFinishBannerTexture(t=20,e=4){const s=document.createElement("canvas");s.width=1024,s.height=256;const a=s.getContext("2d"),r=s.width/t,l=s.height/e;for(let v=0;v<e;v++)for(let m=0;m<t;m++){const o=(v+m)%2===0;a.fillStyle=o?"#111":"#eee",a.fillRect(m*r,v*l,r,l)}a.fillStyle="rgba(0,0,0,0.18)",a.fillRect(0,0,s.width,s.height);const n="FINISH";let h=180;const f=40;a.textAlign="center",a.textBaseline="middle";do{if(a.font=`900 ${h}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,a.measureText(n).width<=s.width-f*2||h<=72)break;h-=4}while(h>72);a.save(),a.shadowColor="rgba(0,0,0,0.6)",a.shadowBlur=8,a.shadowOffsetY=4,a.lineWidth=Math.max(6,Math.floor(h*.06)),a.strokeStyle="rgba(0,0,0,0.9)",a.fillStyle="#ffffff";const d=s.width/2,b=s.height/2+6;return a.strokeText(n,d,b),a.fillText(n,d,b),a.restore(),new nt(s)}}class ye{constructor(t,e,s,a){c(this,"ws",null);c(this,"url");c(this,"roomId");c(this,"playerId");c(this,"name");c(this,"reconnectDelay",1e3);c(this,"handlers",[]);c(this,"closed",!1);this.url=t,this.roomId=e,this.playerId=s,this.name=a||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);if(!e||!e.t)return;this.emit(e)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(t){for(const e of this.handlers)try{e(t)}catch{}}close(){var t;this.closed=!0;try{(t=this.ws)==null||t.close()}catch{}}on(t){this.handlers.push(t)}send(t){var e;try{((e=this.ws)==null?void 0:e.readyState)===1&&this.ws.send(JSON.stringify(t))}catch{}}sendState(t,e){this.send({t:"state",p:t,q:e})}sendLeaderboard(t){this.send({t:"lb",list:t})}}var ge=Z('<div class="countdown svelte-lzoy4r"> </div>'),be=Z('<div class="winner icon-text svelte-lzoy4r"><!> </div>'),Se=Z('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),Me=Z('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),xe=Z('<div class="game-root svelte-lzoy4r"></div> <div class="hud svelte-lzoy4r"><a class="home-btn svelte-lzoy4r" aria-label="Home" title="Home" style="pointer-events:auto"><!> <span>Home</span></a> <!> <div class="speed svelte-lzoy4r"> </div> <div class="audio-controls svelte-lzoy4r" style="pointer-events:auto"><button class="mute-btn svelte-lzoy4r"> </button></div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function Fe(T,t){Pt(t,!1);const e=()=>Ot(Xt,"$page",s),[s,a]=Vt(),r=$();let l=$(null),n=$(null),h=$(3),f=$(0),d=$(null),b=$([]),v=$(!1),m=$(!1),o,p=$(null);At(()=>{o=new Zt,M(p,null);const y=localStorage.getItem("playerName")||"Anonymous";i(l)&&(async()=>{var ht,dt;let u=await o.fetchRoom(i(r));if(!u)try{await o.joinRoom(i(r),y),u=await o.fetchRoom(i(r))}catch{}if(!u){alert("Room not found or no longer available."),history.back();return}const _=o.getPlayerId();if(!!!((ht=u.players)!=null&&ht[_])&&u.status==="waiting")try{await o.joinRoom(i(r),y),u=await o.fetchRoom(i(r))||u}catch{}const A=Object.values(u.players||{}).map(g=>({id:g.id,name:g.name||"Anonymous",isLocal:g.id===_})),C="wss://public_game_ws.realbrain.cc";M(p,new ye(C,u.id,_,y)),i(p).connect(),M(n,new ve(i(l),A));const F=typeof u.raceStartAt=="number"?u.raceStartAt:void 0;i(n).init(F);const st=setInterval(()=>{if(!i(n)||!i(p))return;const{p:g,q:U}=i(n).getLocalTransform();i(p).sendState(g,U)},66);(dt=i(p))==null||dt.on(g=>{if(i(n))if(g.t==="state")i(n).applyRemoteTransform(g.id,g.p,g.q);else if(g.t==="players"){const U=new Set(i(n).getPlayerIds()),j=new Set(g.list.map(G=>G.id));g.list.forEach(G=>{U.has(G.id)||i(n).addPlayer({id:G.id,name:G.name,isLocal:G.id===_})}),U.forEach(G=>{j.has(G)||i(n).removePlayer(G)})}else g.t==="lb"?M(b,g.list):g.t==="winner"?i(d)||(M(d,g.name||"Unknown"),M(v,!0)):g.t==="restart"&&(M(d,null),M(v,!1),i(n).resetForReplay(g.startAt))});const Gt=setInterval(()=>{var g,U,j;if(i(n)){M(h,i(n).getCountdown()),M(f,Math.round(i(n).currentSpeed*3.6));const G=i(n).getWinnerId();G&&!i(d)&&(M(d,((g=A.find(O=>O.id===G))==null?void 0:g.name)||"Unknown"),(U=i(p))==null||U.send({t:"winner",id:G,name:i(d)}),M(v,!0));const pt=i(n).getPlayerStates().sort((O,at)=>at.z-O.z).map((O,at)=>({...O,rank:at+1}));M(b,pt),(j=i(p))==null||j.sendLeaderboard(pt)}},100);k=o.subscribeToRoom(u.id,()=>{}),x=Gt,S=st})()});let x=null,S=null,k=null;Ct(()=>{var y,u;(y=i(n))==null||y.destroy(),M(n,null),x&&clearInterval(x),S&&clearInterval(S),k&&k(),(u=i(p))==null||u.close()}),$t(()=>e(),()=>{M(r,e().params.roomId)}),Et(),Ft();var w=xe(),z=J(w);Ut(z,y=>M(l,y),()=>i(l));var I=L(z,2),R=B(I),P=B(R);me(P,{size:18}),Wt(2),D(R);var X=L(R,2);{var N=y=>{var u=ge(),_=B(u,!0);D(u),Y(()=>V(_,i(h))),H(y,u)},zt=y=>{var u=ct(),_=J(u);{var E=A=>{var C=be(),F=B(C);we(F,{size:20});var st=L(F);D(C),Y(()=>V(st,` Winner: ${i(d)??""}`)),H(A,C)};it(_,A=>{i(d)&&A(E)},!0)}H(y,u)};it(X,y=>{i(h)>0?y(N):y(zt,!1)})}var tt=L(X,2),It=B(tt);D(tt);var et=L(tt,2),q=B(et),kt=B(q,!0);D(q),D(et);var lt=L(et,2),_t=L(B(lt),2);Ht(_t,1,()=>i(b),Nt,(y,u)=>{var _=Se(),E=B(_),A=B(E);D(E);var C=L(E,2),F=B(C,!0);D(C),D(_),Y(()=>{V(A,`${i(u),ft(()=>i(u).rank)??""}.`),V(F,(i(u),ft(()=>i(u).name)))}),H(y,_)}),D(lt),D(I);var Tt=L(I,2);{var Rt=y=>{var u=Me(),_=B(u);D(u),ut("click",_,()=>{var A,C;const E=Date.now()+3e3;(A=i(p))==null||A.send({t:"restart",startAt:E}),(C=i(n))==null||C.resetForReplay(E),M(d,null),M(v,!1)}),H(y,u)};it(Tt,y=>{i(d)&&i(v)&&y(Rt)})}Y(()=>{wt(R,"href",`${fe}/`),V(It,`${i(f)??""} km/h`),wt(q,"aria-pressed",i(m)),V(kt,i(m)?"Unmute":"Mute")}),ut("click",q,()=>{var y;M(m,!i(m)),(y=i(n))==null||y.setMuted(i(m))}),H(T,w),Lt(),a()}export{Fe as component};
