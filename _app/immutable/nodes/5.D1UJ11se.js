var Ze=Object.defineProperty;var ea=(f,t,i)=>t in f?Ze(f,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):f[t]=i;var P=(f,t,i)=>ea(f,typeof t!="symbol"?t+"":t,i);import"../chunks/Bzak7iHL.js";import"../chunks/DrS1WK7l.js";import{o as aa,a as ta}from"../chunks/D-KRtMmF.js";import{h as Ce,a1 as sa,a2 as pe,a3 as oa,a4 as R,al as ra,a9 as h,aa as ia,w as e,v as y,a7 as L,x as c,am as na,a8 as o,ad as r,a5 as n,ak as xe,a6 as Ie,ae as la,u}from"../chunks/BaFMXX1b.js";import{a as m,e as E}from"../chunks/CcETWVYL.js";import{i as J}from"../chunks/BsF4dGg2.js";import{p as ca,R as da,e as De,i as Le}from"../chunks/DOF3g_vQ.js";import{t as va}from"../chunks/BkCE2b-i.js";import{i as pa}from"../chunks/BDHLh8UG.js";import{s as ua,a as ma}from"../chunks/23JgfLWk.js";import{g as M}from"../chunks/0qs9VDFZ.js";import{i as fa}from"../chunks/BigBxC9G.js";import{_ as He}from"../chunks/Dp1pzeXC.js";function $e(f,t,i,b,ue,k){var C=f.__className;if(Ce||C!==i||C===void 0){var x=va(i,b);(!Ce||x!==f.getAttribute("class"))&&(x==null?f.removeAttribute("class"):f.className=x),f.__className=i}return k}const _a=!1,za=Object.freeze(Object.defineProperty({__proto__:null,ssr:_a},Symbol.toStringTag,{value:"Module"}));class Oe{constructor(){P(this,"peer",null);P(this,"connections",new Map);P(this,"isHost",!1);P(this,"onPlayerJoinCallback");P(this,"onPlayerLeaveCallback");P(this,"onDataReceivedCallback");P(this,"onOpenCallback");console.log("PeerManager created")}async initializeHost(){try{const t=await He(()=>import("../chunks/BrLQkHWJ.js"),[],import.meta.url);this.peer=new t.default,this.isHost=!0,this.peer.on("open",i=>{var b;console.log("Host peer initialized with ID:",i),(b=this.onOpenCallback)==null||b.call(this,i)}),this.peer.on("connection",i=>{this.handleNewConnection(i)})}catch(t){console.error("Failed to initialize host:",t)}}async initializeGuest(){try{const t=await He(()=>import("../chunks/BrLQkHWJ.js"),[],import.meta.url);this.peer=new t.default,this.isHost=!1,this.peer.on("open",i=>{var b;console.log("Guest peer initialized with ID:",i),(b=this.onOpenCallback)==null||b.call(this,i)})}catch(t){console.error("Failed to initialize guest:",t)}}handleNewConnection(t){this.connections.set(t.peer,t),t.on("data",i=>{this.onDataReceivedCallback&&this.onDataReceivedCallback(i,t.peer)}),t.on("close",()=>{this.connections.delete(t.peer),this.onPlayerLeaveCallback&&this.onPlayerLeaveCallback(t.peer)}),this.onPlayerJoinCallback&&this.onPlayerJoinCallback({id:t.peer})}getConnectedPeers(){return Array.from(this.connections.keys())}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getIsHost(){return this.isHost}connectToHost(t){if(!this.peer||!t||this.connections.has(t))return;const i=this.peer.connect(t,{reliable:!0});this.handleNewConnection(i)}broadcast(t){for(const i of this.connections.values())try{i.open&&i.send(t)}catch{}}onPlayerJoin(t){this.onPlayerJoinCallback=t}onPlayerLeave(t){this.onPlayerLeaveCallback=t}onDataReceived(t){this.onDataReceivedCallback=t}onOpen(t){this.onOpenCallback=t}disconnect(){this.peer&&(this.peer.destroy(),this.peer=null),this.connections.clear()}}var ga=R('<div class="error-screen svelte-ac1dd4"><div class="error-icon svelte-ac1dd4">‚ùå</div> <h2 class="svelte-ac1dd4">Connection Failed</h2> <p class="svelte-ac1dd4"> </p> <button class="btn-primary svelte-ac1dd4">Back to Menu</button></div>'),ha=R('<div class="loading-screen svelte-ac1dd4"><div class="loading-spinner svelte-ac1dd4"></div> <h2 class="svelte-ac1dd4"> </h2> <p class="svelte-ac1dd4">Setting up multiplayer connection</p></div>'),ya=R('<div><div class="player-avatar svelte-ac1dd4"> </div> <div class="player-info svelte-ac1dd4"><span class="player-name svelte-ac1dd4"> </span> <span class="player-role svelte-ac1dd4"> </span></div> <div class="connection-status svelte-ac1dd4"> </div></div>'),ba=R('<div class="player-card empty svelte-ac1dd4"><div class="player-avatar svelte-ac1dd4">üë§</div> <div class="player-info svelte-ac1dd4"><span class="player-name svelte-ac1dd4">Waiting for player...</span></div></div>'),ka=R('<button class="btn-primary start-btn svelte-ac1dd4"> </button>'),Ra=R('<div class="waiting-message svelte-ac1dd4"><span class="pulse-dot svelte-ac1dd4"></span> Waiting for host to start the race...</div>'),wa=R('<div class="share-section svelte-ac1dd4"><h4 class="svelte-ac1dd4">Invite Friends</h4> <p class="svelte-ac1dd4">Share this room with your friends so they can join:</p> <div class="share-text svelte-ac1dd4"><div class="svelte-ac1dd4"><strong class="svelte-ac1dd4">ID:</strong> </div> <div style="margin-top: .5rem; word-break: break-all;" class="svelte-ac1dd4"><strong class="svelte-ac1dd4">Link:</strong> </div></div> <div class="lobby-actions svelte-ac1dd4" style="margin-top: 1rem;"><button class="btn-secondary svelte-ac1dd4"> </button> <button class="btn-secondary svelte-ac1dd4"> </button></div></div>'),Pa=R('<div class="lobby-content svelte-ac1dd4"><div class="room-header svelte-ac1dd4"><h1 class="svelte-ac1dd4">üèÅ Racing Lobby</h1> <div class="room-info svelte-ac1dd4"><div class="room-id svelte-ac1dd4"><span class="label svelte-ac1dd4">Room ID:</span> <div class="id-container svelte-ac1dd4"><span class="room-code svelte-ac1dd4"> </span> <button class="copy-btn svelte-ac1dd4" title="Copy Room ID"> </button></div></div> <div> </div></div></div> <div class="players-section svelte-ac1dd4"><h3 class="svelte-ac1dd4"> </h3> <div class="players-list svelte-ac1dd4"><!> <!></div></div> <div class="game-settings svelte-ac1dd4"><h3 class="svelte-ac1dd4">Game Settings</h3> <div class="settings-grid svelte-ac1dd4"><div class="setting-item svelte-ac1dd4"><span class="label svelte-ac1dd4">Track:</span> <span class="svelte-ac1dd4">Default Track</span></div> <div class="setting-item svelte-ac1dd4"><span class="label svelte-ac1dd4">Mode:</span> <span class="svelte-ac1dd4">Sunny</span></div> <div class="setting-item svelte-ac1dd4"><span class="label svelte-ac1dd4">Max Players:</span> <span class="svelte-ac1dd4"> </span></div></div></div> <div class="lobby-actions svelte-ac1dd4"><!> <button class="btn-secondary svelte-ac1dd4">Leave Room</button></div> <!></div>'),Ca=R('<div class="lobby-container svelte-ac1dd4"><!></div>');function Aa(f,t){sa(t,!1);const i=()=>ma(ca,"$page",b),[b,ue]=ua(),k=y(),C=y(),x=y();let d,v,s=y(null),w=y(!1),W="",U=y(!1),F=y(""),z=y([]),A=y(!1),V=y(!1),B=!1;aa(async()=>{if(W=localStorage.getItem("playerName")||"Anonymous",!fa()){c(F,"Firebase not configured. Multiplayer is unavailable.");return}d=new da,c(U,!0);try{e(C)?await je():await Ee()}catch(a){console.error("Room operation failed:",a),c(F,a instanceof Error?a.message:"Failed to connect to room")}finally{c(U,!1)}}),ta(()=>{v&&v.disconnect(),d&&!B&&d.leaveRoom()});async function je(){try{const a=await d.createRoom(W);c(s,d.getCurrentRoom()),c(w,!0),v=new Oe,await v.initializeHost();const _=v.getPeerId();_&&await d.setHostPeerId(_),console.log("Room created:",a),me(),fe(),M(`/lobby/${a}`,{replaceState:!0})}catch(a){throw new Error("Failed to create room: "+(a instanceof Error?a.message:"Unknown error"))}}async function Ee(){try{if(!e(k)||e(k)==="create")throw new Error("Invalid room link. Please create a new room or check the room ID.");if(await d.joinRoom(e(k),W),c(s,d.getCurrentRoom()),!e(s))throw new Error("Room not found or no longer available");v=new Oe,await v.initializeGuest(),console.log("Joined room:",e(s).id),me(),fe()}catch(a){throw new Error("Failed to join room: "+(a instanceof Error?a.message:"Unknown error"))}}function me(){v&&(v.onPlayerJoin(a=>{console.log("Player joined:",a),c(z,v.getConnectedPeers())}),v.onPlayerLeave(a=>{console.log("Player left:",a),c(z,v.getConnectedPeers())}),v.onDataReceived((a,_)=>{console.log("Received data from",_,":",a)}))}function fe(){d&&(d.onPlayerJoin(a=>{console.log("Realtime join:",a)}),d.onPlayerLeave(a=>{console.log("Realtime leave:",a)}),d.onRoomError(a=>{console.error("Room error:",a)}),d.onRoomUpdate(a=>{if(c(s,a),a&&!e(w)&&a.hostPeerId)try{v==null||v.connectToHost(a.hostPeerId)}catch{}a&&a.status==="racing"&&(B=!0,M(`/game/multiplayer/${a==null?void 0:a.id}`))}))}function _e(){var a;(a=e(s))!=null&&a.id&&(navigator.clipboard.writeText(e(s).id),c(A,!0),setTimeout(()=>c(A,!1),1500))}function Se(){var a;if((a=e(s))!=null&&a.id){const _=`${location.origin}/lobby/${e(s).id}`;navigator.clipboard.writeText(_),c(V,!0),setTimeout(()=>c(V,!1),1500)}}async function Te(){e(w)&&e(s)&&(B=!0,await d.startGame(),M(`/game/multiplayer/${e(s).id}`))}function Je(){d&&d.leaveRoom(),M("/")}pe(()=>i(),()=>{c(k,i().params.roomId)}),pe(()=>e(k),()=>{c(C,e(k)==="create")}),pe(()=>(e(w),e(s)),()=>{c(x,e(w)&&e(s)&&Object.keys(e(s).players).length>=2)}),oa(),pa();var q=Ca();ra(a=>{L(()=>na.title=`
    ${e(C)?"Creating Room":`Room ${e(k)}`} - Speed Racers
  `)});var Me=o(q);{var Fe=a=>{var _=ga(),S=n(o(_),4),K=o(S,!0);r(S);var Q=n(S,2);r(_),L(()=>m(K,e(F))),E("click",Q,()=>M("/")),h(a,_)},ze=a=>{var _=xe(),S=Ie(_);{var K=H=>{var $=ha(),G=n(o($),2),X=o(G,!0);r(G),la(2),r($),L(()=>m(X,e(C)?"Creating Room...":"Joining Room...")),h(H,$)},Q=H=>{var $=xe(),G=Ie($);{var X=Y=>{var Z=Pa(),ee=o(Z),ge=n(o(ee),2),ae=o(ge),he=n(o(ae),2),te=o(he),Ae=o(te,!0);r(te);var se=n(te,2),Ge=o(se,!0);r(se),r(he),r(ae);var oe=n(ae,2),Ne=o(oe,!0);r(oe),r(ge),r(ee);var re=n(ee,2),ie=o(re),We=o(ie);r(ie);var ye=n(ie,2),be=o(ye);De(be,1,()=>(e(s),u(()=>Object.values(e(s).players))),Le,(p,l)=>{var g=ya(),I=o(g),ce=o(I,!0);r(I);var O=n(I,2),T=o(O),N=o(T,!0);r(T);var D=n(T,2),de=o(D,!0);r(D),r(O);var j=n(O,2),ve=o(j,!0);r(j),r(g),L(Ye=>{$e(g,1,`player-card ${e(l),u(()=>e(l).isHost?"host":"")??""}`,"svelte-ac1dd4"),m(ce,(e(l),u(()=>e(l).isHost?"üëë":"üèéÔ∏è"))),m(N,(e(l),u(()=>e(l).name||"Anonymous"))),m(de,(e(l),u(()=>e(l).isHost?"Host":"Player"))),m(ve,Ye)},[()=>(e(z),e(l),u(()=>e(z).includes(e(l).id)||e(l).isHost?"üü¢":"üî¥"))]),h(p,g)});var Ue=n(be,2);De(Ue,1,()=>(e(s),u(()=>Array(4-Object.keys(e(s).players).length))),Le,(p,l)=>{var g=ba();h(p,g)}),r(ye),r(re);var ne=n(re,2),ke=n(o(ne),2),Re=n(o(ke),4),we=n(o(Re),2),Ve=o(we,!0);r(we),r(Re),r(ke),r(ne);var le=n(ne,2),Pe=o(le);{var Be=p=>{var l=ka(),g=o(l,!0);r(l),L(()=>{l.disabled=!e(x),m(g,e(x)?"üöÄ Start Race":"Waiting for Players...")}),E("click",l,Te),h(p,l)},qe=p=>{var l=Ra();h(p,l)};J(Pe,p=>{e(w)?p(Be):p(qe,!1)})}var Ke=n(Pe,2);r(le);var Qe=n(le,2);{var Xe=p=>{var l=wa(),g=n(o(l),4),I=o(g),ce=n(o(I));r(I);var O=n(I,2),T=n(o(O));r(O),r(g);var N=n(g,2),D=o(N),de=o(D,!0);r(D);var j=n(D,2),ve=o(j,!0);r(j),r(N),r(l),L(()=>{m(ce,` ${e(s),u(()=>e(s).id)??""}`),m(T,` ${u(()=>location.origin)??""}/lobby/${e(s),u(()=>e(s).id)??""}`),m(de,e(A)?"‚úÖ ID Copied":"Copy ID"),m(ve,e(V)?"‚úÖ Link Copied":"Copy Link")}),E("click",D,_e),E("click",j,Se),h(p,l)};J(Qe,p=>{e(w),e(s),u(()=>e(w)&&Object.keys(e(s).players).length===1)&&p(Xe)})}r(Z),L(p=>{m(Ae,(e(s),u(()=>e(s).id))),m(Ge,e(A)?"‚úÖ":"üìã"),$e(oe,1,`status-badge ${e(s),u(()=>e(s).status)??""}`,"svelte-ac1dd4"),m(Ne,(e(s),u(()=>e(s).status==="waiting"?"‚è≥ Waiting":e(s).status==="racing"?"üèÅ Racing":"üèÜ Finished"))),m(We,`Players (${p??""}/4)`),m(Ve,(e(s),u(()=>e(s).maxPlayers)))},[()=>(e(s),u(()=>Object.keys(e(s).players).length))]),E("click",se,_e),E("click",Ke,Je),h(Y,Z)};J(G,Y=>{e(s)&&Y(X)},!0)}h(H,$)};J(S,H=>{e(U)?H(K):H(Q,!1)},!0)}h(a,_)};J(Me,a=>{e(F)?a(Fe):a(ze,!1)})}r(q),h(f,q),ia(),ue()}export{Aa as component,za as universal};
