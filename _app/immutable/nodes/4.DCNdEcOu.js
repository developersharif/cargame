var pe=Object.defineProperty;var ue=(b,t,e)=>t in b?pe(b,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):b[t]=e;var r=(b,t,e)=>ue(b,typeof t!="symbol"?t+"":t,e);import"../chunks/Bzak7iHL.js";import"../chunks/DrS1WK7l.js";import{o as me,a as fe}from"../chunks/D-KRtMmF.js";import{a1 as we,a2 as ye,a3 as ve,a4 as N,a6 as Y,a7 as T,a9 as D,aa as ge,x as h,v as z,w as s,a5 as P,a8 as k,ad as _,ak as Se,u as ee}from"../chunks/BaFMXX1b.js";import{g as te,a as L,e as be}from"../chunks/CcETWVYL.js";import{i as H}from"../chunks/BsF4dGg2.js";import{e as Ie,R as ze,i as ke,p as _e}from"../chunks/DOF3g_vQ.js";import{b as Re}from"../chunks/_Chv9gBj.js";import{i as xe}from"../chunks/BDHLh8UG.js";import{s as Ae,a as De}from"../chunks/23JgfLWk.js";import{S as Pe,P as Me,W as Ce,C as Ee,a as Le,I as Ne,R as We,b as Te,c as Ge,E as Ue,T as Fe,d as se,A as $e,M as je,V as ae,Q as Be,e as He,L as qe,f as Ke,g as Oe}from"../chunks/tXehg3D1.js";import{s as q}from"../chunks/DSzE6Y4I.js";class Qe{constructor(t,e){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"clock");r(this,"physics");r(this,"input");r(this,"renderSystem");r(this,"chaseCamera");r(this,"environment");r(this,"track");r(this,"audio");r(this,"running",!1);r(this,"disposeBag",[]);r(this,"players",new Map);r(this,"localId");r(this,"countdown",3);r(this,"countdownStartAt",null);r(this,"raceStarted",!1);r(this,"finishZ",600);r(this,"winnerId",null);r(this,"frozen",!1);r(this,"currentSpeed",0);r(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta();this.update(t),this.render(),requestAnimationFrame(this.loop)});r(this,"updateSize",()=>{var a,o;const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(o=(a=this.renderSystem).updateSize)==null||o.call(a,t,e)});var o;this.container=t,this.scene=new Pe,this.camera=new Me(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new Ce({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Ee,this.physics=new Le,this.input=new Ne(t),this.renderSystem=new We(this.scene,this.camera,this.renderer),this.chaseCamera=new Te(this.camera);const a=e.find(l=>l.isLocal);this.localId=a?a.id:(o=e[0])==null?void 0:o.id,e.forEach(l=>{this.players.set(l.id,{info:l,car:null,label:null})})}init(t){const e=te(q);this.renderer.setPixelRatio(Math.min(devicePixelRatio,e.graphics.resolution)),this.renderer.shadowMap.enabled=!!e.graphics.shadows,this.renderer.shadowMap.type=Ge,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new Ue(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Fe,this.scene.add(this.track.group),Array.from(this.players.keys()).forEach(p=>{const i=new se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});i.setPosition(0,0,0),i.setHeading(0),this.scene.add(i.group);const w=this.createNameLabel(this.players.get(p).info.name);i.group.add(w),w.position.set(0,2.2,0),this.players.set(p,{...this.players.get(p),car:i,label:w})}),this.relineUpGrid(),this.audio=new $e(this.camera),this.applySettingsToAudio();const o=q.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>o());const l=this.players.get(this.localId).car;this.chaseCamera.update(0,l.group),this.running=!0,this.clock.start(),this.loop(),t?this.countdownStartAt=t:this.countdownStartAt=Date.now()}update(t){var a;if(this.frozen)return;this.physics.update(t);const e=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const o=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(o)),o>=3&&(this.raceStarted=!0)}if(this.raceStarted){const o=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),l=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),p=this.input.isDown("Space"),i=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),w=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),A=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),m=je.clamp(w-A,-1,1);e.car.setInputs({throttle:o,brake:l,steering:m,handbrake:p,boost:i})}else e.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1});if(this.players.forEach(({car:o})=>o.update(t)),this.currentSpeed=e.car.getSpeed(),this.chaseCamera.update(t,e.car.group),this.track.update(e.car.group.position.z),(a=this.environment)==null||a.update(e.car.group.position.z),!this.winnerId){for(const[o,l]of this.players)if(l.car.group.position.z>=this.finishZ){this.winnerId=o;break}}}render(){this.renderSystem.render()}destroy(){var t;this.running=!1,this.clock.stop(),this.disposeBag.forEach(e=>e()),(t=this.environment)==null||t.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}resetForReplay(t){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(e=>{e.car.reset(new ae(0,0,0),0)}),this.relineUpGrid(),this.countdownStartAt=t||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const t=this.players.get(this.localId),e=t.car.group.position,a=t.car.group.quaternion;return{p:[e.x,e.y,e.z],q:[a.x,a.y,a.z,a.w]}}applyRemoteTransform(t,e,a){const o=this.players.get(t);if(!o||t===this.localId)return;const l=new ae(e[0],e[1],e[2]),p=new Be(a[0],a[1],a[2],a[3]);o.car.group.position.lerp(l,.35),o.car.group.quaternion.slerp(p,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(t){if(this.players.has(t.id))return;const e=new se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});e.setPosition(0,0,0),e.setHeading(0),this.scene.add(e.group);const a=this.createNameLabel(t.name);e.group.add(a),a.position.set(0,2.2,0),this.players.set(t.id,{info:t,car:e,label:a}),this.raceStarted||this.relineUpGrid()}removePlayer(t){const e=this.players.get(t);if(e){try{this.scene.remove(e.car.group)}catch{}this.players.delete(t),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const t=[];return this.players.forEach((e,a)=>{t.push({id:a,name:e.info.name,z:e.car.group.position.z})}),t}relineUpGrid(){const t=Array.from(this.players.keys()),e=Math.min(3,Math.max(2,t.length)),a=2.5,o=4,l=0;t.forEach((p,i)=>{const w=Math.floor(i/e),A=i%e,M=-((e-1)*a)/2+A*a,R=l-w*o,y=this.players.get(p);y.car.setPosition(M,0,R),y.car.setHeading(0)})}applySettingsToAudio(){var e;const t=te(q);(e=this.audio)==null||e.updateFromSettings(t)}createNameLabel(t){const e=document.createElement("canvas");e.width=256,e.height=64;const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height),a.fillStyle="rgba(0,0,0,0.6)",a.fillRect(0,0,e.width,e.height),a.fillStyle="#fff",a.font="bold 28px sans-serif",a.textAlign="center",a.textBaseline="middle",a.fillText(t,e.width/2,e.height/2);const o=new He(e);o.minFilter=qe;const l=new Ke({map:o,transparent:!0}),p=new Oe(l);return p.scale.set(2.5,.6,1),p}}class Ze{constructor(t,e,a,o){r(this,"ws",null);r(this,"url");r(this,"roomId");r(this,"playerId");r(this,"name");r(this,"reconnectDelay",1e3);r(this,"handlers",[]);r(this,"closed",!1);this.url=t,this.roomId=e,this.playerId=a,this.name=o||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);if(!e||!e.t)return;this.emit(e)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(t){for(const e of this.handlers)try{e(t)}catch{}}close(){var t;this.closed=!0;try{(t=this.ws)==null||t.close()}catch{}}on(t){this.handlers.push(t)}send(t){var e;try{((e=this.ws)==null?void 0:e.readyState)===1&&this.ws.send(JSON.stringify(t))}catch{}}sendState(t,e){this.send({t:"state",p:t,q:e})}sendLeaderboard(t){this.send({t:"lb",list:t})}}var Je=N('<div class="countdown svelte-lzoy4r"> </div>'),Ve=N('<div class="winner svelte-lzoy4r"> </div>'),Xe=N('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),Ye=N('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),et=N('<div class="game-root svelte-lzoy4r"></div> <div class="hud svelte-lzoy4r"><!> <div class="speed svelte-lzoy4r"> </div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function ft(b,t){we(t,!1);const e=()=>De(_e,"$page",a),[a,o]=Ae(),l=z();let p=z(null),i=z(null),w=z(3),A=z(0),m=z(null),M=z([]),R=z(!1),y,S=z(null);me(()=>{y=new ze,h(S,null);const d=localStorage.getItem("playerName")||"Anonymous";s(p)&&(async()=>{var J,V;let n=await y.fetchRoom(s(l));if(!n)try{await y.joinRoom(s(l),d),n=await y.fetchRoom(s(l))}catch{}if(!n){alert("Room not found or no longer available."),history.back();return}const u=y.getPlayerId();if(!!!((J=n.players)!=null&&J[u])&&n.status==="waiting")try{await y.joinRoom(s(l),d),n=await y.fetchRoom(s(l))||n}catch{}const v=Object.values(n.players||{}).map(c=>({id:c.id,name:c.name||"Anonymous",isLocal:c.id===u})),g="wss://your-relay-domain.example.com";h(S,new Ze(g,n.id,u,d)),s(S).connect(),h(i,new Qe(s(p),v));const C=typeof n.raceStartAt=="number"?n.raceStartAt:void 0;s(i).init(C);const de=setInterval(()=>{if(!s(i)||!s(S))return;const{p:c,q:x}=s(i).getLocalTransform();s(S).sendState(c,x)},66);(V=s(S))==null||V.on(c=>{if(s(i))if(c.t==="state")s(i).applyRemoteTransform(c.id,c.p,c.q);else if(c.t==="players"){const x=new Set(s(i).getPlayerIds()),W=new Set(c.list.map(f=>f.id));c.list.forEach(f=>{x.has(f.id)||s(i).addPlayer({id:f.id,name:f.name,isLocal:f.id===u})}),x.forEach(f=>{W.has(f)||s(i).removePlayer(f)})}else c.t==="lb"?h(M,c.list):c.t==="winner"?s(m)||(h(m,c.name||"Unknown"),s(i).freeze(),h(R,!0)):c.t==="restart"&&(h(m,null),h(R,!1),s(i).resetForReplay(c.startAt))});const he=setInterval(()=>{var c,x,W;if(s(i)){h(w,s(i).getCountdown()),h(A,Math.round(s(i).currentSpeed*3.6));const f=s(i).getWinnerId();f&&!s(m)&&(h(m,((c=v.find(E=>E.id===f))==null?void 0:c.name)||"Unknown"),s(i).freeze(),(x=s(S))==null||x.send({t:"winner",id:f,name:s(m)}),h(R,!0));const X=s(i).getPlayerStates().sort((E,B)=>B.z-E.z).map((E,B)=>({...E,rank:B+1}));h(M,X),(W=s(S))==null||W.sendLeaderboard(X)}},100);F=y.subscribeToRoom(n.id,()=>{}),G=he,U=de})()});let G=null,U=null,F=null;fe(()=>{var d,n;(d=s(i))==null||d.destroy(),h(i,null),G&&clearInterval(G),U&&clearInterval(U),F&&F(),(n=s(S))==null||n.close()}),ye(()=>e(),()=>{h(l,e().params.roomId)}),ve(),xe();var K=et(),O=Y(K);Re(O,d=>h(p,d),()=>s(p));var $=P(O,2),Q=k($);{var re=d=>{var n=Je(),u=k(n,!0);_(n),T(()=>L(u,s(w))),D(d,n)},ie=d=>{var n=Se(),u=Y(n);{var I=v=>{var g=Ve(),C=k(g);_(g),T(()=>L(C,`🏆 Winner: ${s(m)??""}`)),D(v,g)};H(u,v=>{s(m)&&v(I)},!0)}D(d,n)};H(Q,d=>{s(w)>0?d(re):d(ie,!1)})}var j=P(Q,2),ne=k(j);_(j);var Z=P(j,2),oe=P(k(Z),2);Ie(oe,1,()=>s(M),ke,(d,n)=>{var u=Xe(),I=k(u),v=k(I);_(I);var g=P(I,2),C=k(g,!0);_(g),_(u),T(()=>{L(v,`${s(n),ee(()=>s(n).rank)??""}.`),L(C,(s(n),ee(()=>s(n).name)))}),D(d,u)}),_(Z),_($);var le=P($,2);{var ce=d=>{var n=Ye(),u=k(n);_(n),be("click",u,()=>{var v,g;const I=Date.now()+3e3;(v=s(S))==null||v.send({t:"restart",startAt:I}),(g=s(i))==null||g.resetForReplay(I),h(m,null),h(R,!1)}),D(d,n)};H(le,d=>{s(m)&&s(R)&&d(ce)})}T(()=>L(ne,`${s(A)??""} km/h`)),D(b,K),ge(),o()}export{ft as component};
