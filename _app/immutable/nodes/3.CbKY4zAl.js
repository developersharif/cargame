var St=Object.defineProperty;var bt=(m,t,s)=>t in m?St(m,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):m[t]=s;var r=(m,t,s)=>bt(m,typeof t!="symbol"?t+"":t,s);import"../chunks/Bzak7iHL.js";import"../chunks/DBaa8ihH.js";import{o as yt,a as Mt}from"../chunks/C-Zct2oW.js";import{g as kt,a7 as xt,O as At,T as nt,W as Ct,X as it,Z as rt,_ as Lt,b as u,$ as k,Y as f,V as b,d as y,a2 as v}from"../chunks/u0ziBGJF.js";import{g as Y,e as _t,s as A}from"../chunks/bEr8L69U.js";import{i as Dt}from"../chunks/BlZ7KARV.js";import{s as Tt,a as at}from"../chunks/BKIDMDWj.js";import{b as Bt}from"../chunks/CMgg6DdI.js";import{s as Pt}from"../chunks/Bd-89TeU.js";import{i as Et}from"../chunks/qAnzbP_n.js";import{m as It,j as zt,V as C,n as N,o as x,p as Z,q as ot,r as U,G as j,S as Rt,P as Gt,W as $t,C as Ft,a as Ht,I as Vt,R as Wt,b as Ot,c as Xt,E as Kt,T as Nt,e as Zt,d as Ut,A as jt,M as q}from"../chunks/D35hHXiw.js";import{s as B}from"../chunks/DUltNUP4.js";import{b as qt}from"../chunks/D4yqHI2T.js";function Yt(m,t,s){var e=kt(m,t);e&&e.set&&(m[t]=s,xt(()=>{m[t]=null}))}class F{static disposeMaterial(t){if(!t)return;const s=e=>{var i,o;e.map&&((o=(i=e.map).dispose)==null||o.call(i)),e.dispose()};Array.isArray(t)?t.forEach(s):s(t)}static disposeObject(t){t.traverse(s=>{var e,i,o,c;s.geometry&&((i=(e=s.geometry).dispose)==null||i.call(e)),s.material&&F.disposeMaterial(s.material),s instanceof It&&((o=s.dispose)==null||o.call(s)),s instanceof zt&&((c=s.userData)!=null&&c.dispose)&&s.userData.dispose()})}static disposeScene(t){t.traverse(s=>{var e,i;s.geometry&&((i=(e=s.geometry).dispose)==null||i.call(e)),s.material&&F.disposeMaterial(s.material)})}}class Jt{constructor(t){r(this,"checkpoints",[]);r(this,"currentIndex",0);r(this,"lapStart",performance.now());r(this,"currentLapMs",0);r(this,"bestLapMs",null);this.checkpoints=t}update(t,s){this.currentLapMs=t-this.lapStart;const e=this.checkpoints[this.currentIndex];if(e&&s.distanceTo(e.position)<=e.radius&&(this.currentIndex++,this.currentIndex>=this.checkpoints.length)){const i=this.currentLapMs;(this.bestLapMs===null||i<this.bestLapMs)&&(this.bestLapMs=i),this.lapStart=t,this.currentLapMs=0,this.currentIndex=0}}getHudTimes(){return{current:this.currentLapMs,best:this.bestLapMs}}}class Qt{constructor(){r(this,"score",0);r(this,"distance",0);r(this,"combo",0);r(this,"lastScoreTime",0);r(this,"comboDecayTime",3e3);r(this,"lastPosition",new C);r(this,"startTime",0);this.startTime=performance.now(),this.lastScoreTime=this.startTime}update(t,s,e){const i=performance.now(),o=s.distanceTo(this.lastPosition);if(this.distance+=o,this.lastPosition.copy(s),o>0){const c=Math.floor(o*10);this.addScore(c,"distance")}if(e>20){const c=Math.floor((e-20)*2);this.addScore(c,"speed")}i-this.lastScoreTime>this.comboDecayTime&&(this.combo=0)}addScore(t,s="general"){const e=performance.now();e-this.lastScoreTime<1e3?this.combo=Math.min(this.combo+1,10):this.combo=Math.max(1,this.combo);const i=t*this.combo;return this.score+=i,this.lastScoreTime=e,i}addObstacleAvoidanceBonus(){return this.addScore(50,"avoidance")}addNearMissBonus(){return this.addScore(25,"nearmiss")}subtractCollisionPenalty(){this.score=Math.max(0,this.score-100),this.combo=0}getScoreData(){return{total:this.score,distance:this.distance,combo:this.combo,lastScoreTime:this.lastScoreTime}}reset(){this.score=0,this.distance=0,this.combo=0,this.lastScoreTime=performance.now(),this.lastPosition.set(0,0,0)}}class te{constructor(t,s){r(this,"scene");r(this,"camera");r(this,"particleGroups",[]);r(this,"screenShakeIntensity",0);r(this,"screenShakeDecay",.95);r(this,"originalCameraPosition",new C);this.scene=t,this.camera=s}update(t){this.updateParticles(t),this.updateScreenShake(t),this.cleanupParticles()}createCollisionEffect(t,s=1){this.createSparks(t,s),this.createDebris(t,s),this.addScreenShake(s*.5)}createBoostEffect(t){const e=new N,i=new Float32Array(60),o=new Float32Array(60),c=new Float32Array(20);for(let a=0;a<20;a++)i[a*3]=t.x+(Math.random()-.5)*2,i[a*3+1]=t.y+Math.random()*.5,i[a*3+2]=t.z-Math.random()*3,o[a*3]=.2+Math.random()*.3,o[a*3+1]=.8+Math.random()*.2,o[a*3+2]=1,c[a]=Math.random()*.1+.05;e.setAttribute("position",new x(i,3)),e.setAttribute("color",new x(o,3)),e.setAttribute("size",new x(c,1));const d=new Z({size:.1,vertexColors:!0,blending:ot,transparent:!0,opacity:.8}),w=new U(e,d),l=new j;l.add(w),l.startTime=performance.now(),l.duration=1e3,l.type="boost",this.scene.add(l),this.particleGroups.push(l)}createSparks(t,s){const e=Math.floor(20*s),i=new N,o=new Float32Array(e*3),c=new Float32Array(e*3),d=new Float32Array(e*3);for(let n=0;n<e;n++)o[n*3]=t.x,o[n*3+1]=t.y,o[n*3+2]=t.z,c[n*3]=(Math.random()-.5)*10,c[n*3+1]=Math.random()*5+2,c[n*3+2]=(Math.random()-.5)*10,d[n*3]=1,d[n*3+1]=.5+Math.random()*.5,d[n*3+2]=0;i.setAttribute("position",new x(o,3)),i.setAttribute("velocity",new x(c,3)),i.setAttribute("color",new x(d,3));const w=new Z({size:.05,vertexColors:!0,blending:ot,transparent:!0}),l=new U(i,w),a=new j;a.add(l),a.startTime=performance.now(),a.duration=1500,a.type="sparks",this.scene.add(a),this.particleGroups.push(a)}createDebris(t,s){const e=Math.floor(15*s),i=new N,o=new Float32Array(e*3),c=new Float32Array(e*3),d=new Float32Array(e*3);for(let n=0;n<e;n++){o[n*3]=t.x+(Math.random()-.5)*.5,o[n*3+1]=t.y+Math.random()*.5,o[n*3+2]=t.z+(Math.random()-.5)*.5,c[n*3]=(Math.random()-.5)*3,c[n*3+1]=Math.random()*2+1,c[n*3+2]=(Math.random()-.5)*3;const g=.3+Math.random()*.4;d[n*3]=g,d[n*3+1]=g*.8,d[n*3+2]=g*.6}i.setAttribute("position",new x(o,3)),i.setAttribute("velocity",new x(c,3)),i.setAttribute("color",new x(d,3));const w=new Z({size:.08,vertexColors:!0,transparent:!0,opacity:.7}),l=new U(i,w),a=new j;a.add(l),a.startTime=performance.now(),a.duration=2e3,a.type="debris",this.scene.add(a),this.particleGroups.push(a)}updateParticles(t){const s=performance.now();this.particleGroups.forEach(e=>{var g;const i=s-e.startTime,o=e.duration,c=i/o;if(c>=1)return;const d=e.children[0],w=d.geometry,l=w.attributes.position.array,a=(g=w.attributes.velocity)==null?void 0:g.array;if(a){for(let S=0;S<l.length;S+=3)l[S]+=a[S]*t,l[S+1]+=a[S+1]*t,l[S+2]+=a[S+2]*t,a[S+1]-=9.8*t;w.attributes.position.needsUpdate=!0}const n=d.material;n.opacity=1-c})}addScreenShake(t){this.screenShakeIntensity=Math.max(this.screenShakeIntensity,t)}updateScreenShake(t){if(this.screenShakeIntensity>0){const s=(Math.random()-.5)*this.screenShakeIntensity,e=(Math.random()-.5)*this.screenShakeIntensity,i=(Math.random()-.5)*this.screenShakeIntensity;this.originalCameraPosition.length()===0&&this.originalCameraPosition.copy(this.camera.position),this.camera.position.add(new C(s,e,i)),this.screenShakeIntensity*=this.screenShakeDecay,this.screenShakeIntensity<.001&&(this.screenShakeIntensity=0)}}cleanupParticles(){const t=performance.now();this.particleGroups=this.particleGroups.filter(s=>{const e=t-s.startTime,i=s.duration;return e>=i?(this.scene.remove(s),!1):!0})}dispose(){this.particleGroups.forEach(t=>{this.scene.remove(t)}),this.particleGroups=[]}}class ee{constructor(t){r(this,"scene");r(this,"camera");r(this,"renderer");r(this,"clock");r(this,"physics");r(this,"input");r(this,"renderSystem");r(this,"chaseCamera");r(this,"running",!1);r(this,"disposeBag",[]);r(this,"car");r(this,"track");r(this,"collision");r(this,"lap");r(this,"score");r(this,"effects");r(this,"audio");r(this,"unsubSettings");r(this,"throttleInput",0);r(this,"steerSensitivity",1);r(this,"environment");r(this,"currentSpeed",0);r(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta();this.update(t),this.render(),requestAnimationFrame(this.loop)});r(this,"updateSize",()=>{var e,i;const t=window.innerWidth,s=window.innerHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(i=(e=this.renderSystem).updateSize)==null||i.call(e,t,s)});this.container=t,this.scene=new Rt,this.camera=new Gt(60,1,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.renderer=new $t({antialias:!0,alpha:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Ft,this.physics=new Ht,this.input=new Vt(t),this.renderSystem=new Wt(this.scene,this.camera,this.renderer),this.chaseCamera=new Ot(this.camera)}init(){const t=Y(B);this.renderer.setPixelRatio(Math.min(devicePixelRatio,t.graphics.resolution)),this.renderer.shadowMap.enabled=!!t.graphics.shadows,this.renderer.shadowMap.type=Xt,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new Kt(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Nt,this.scene.add(this.track.group),this.car=new Zt({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}}),this.car.setPosition(0,0,0),this.car.setHeading(0),this.scene.add(this.car.group),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.chaseCamera.update(0,this.car.group),this.collision=new Ut(this.track.obstacles),this.score=new Qt,this.effects=new te(this.scene,this.camera),this.audio=new jt(this.camera),this.applySettingsToAudio();const s=B.subscribe(()=>this.applySettingsToAudio());this.unsubSettings=()=>s();const e=async()=>{var o;await((o=this.audio)==null?void 0:o.resume()),window.removeEventListener("keydown",e,!0),window.removeEventListener("pointerdown",e,!0),this.disposeBag=this.disposeBag.filter(c=>c!==i)},i=()=>{window.removeEventListener("keydown",e,!0),window.removeEventListener("pointerdown",e,!0)};window.addEventListener("keydown",e,!0),window.addEventListener("pointerdown",e,!0),this.disposeBag.push(i),this.lap=new Jt([{position:new C(0,0,100),radius:5},{position:new C(0,0,200),radius:5},{position:new C(0,0,300),radius:5},{position:new C(0,0,400),radius:5}]),this.running=!0,this.clock.start(),this.loop()}update(t){var I,z,R,D;this.physics.update(t);const s=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),e=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),i=this.input.isDown("Space"),o=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),c=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),d=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),w=q.clamp((c-d)*this.steerSensitivity,-1,1);this.car.setInputs({throttle:s,brake:e,steering:w,handbrake:i,boost:o}),this.throttleInput=s,this.car.update(t),this.currentSpeed=this.car.getSpeed(),this.chaseCamera.update(t,this.car.group),this.track.update(this.car.group.position.z),(I=this.environment)==null||I.update(this.car.group.position.z),this.score.update(t,this.car.group.position,this.currentSpeed),this.effects.update(t),(this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"))&&this.throttleInput>0&&this.effects.createBoostEffect(this.car.group.position);const a=this.car.group.position,n=.6,g=1.2,S={minX:a.x-n,maxX:a.x+n,minZ:a.z-g,maxZ:a.z+g},_=this.car.getVelocityRef().clone();if(this.collision.resolve(a,this.car.getVelocityRef(),S)){const G=this.car.getVelocityRef(),H=_.clone().sub(G),T=q.clamp(H.length()*.1,0,1);(z=this.audio)==null||z.playCollision(T),this.score.subtractCollisionPenalty(),this.effects.createCollisionEffect(this.car.group.position,T)}const P=25;Math.abs(a.x)>P&&(a.x=q.clamp(a.x,-P,P)),this.input.isDown("KeyR")&&this.car.reset(new C(0,0,0),0),this.lap.update(performance.now(),this.car.group.position),(R=this.audio)==null||R.setEngine(this.throttleInput,this.currentSpeed,this.car.config.maxSpeed);const E=((D=this.getBoostLevel)==null?void 0:D.call(this))??0;this.chaseCamera.setBoostVisual(1-E<.001?0:this.throttleInput>0?1-E*.2:0)}render(){this.renderSystem.render()}destroy(){var t,s,e;this.running=!1,this.clock.stop(),this.disposeBag.forEach(i=>i()),(t=this.unsubSettings)==null||t.call(this),(s=this.environment)==null||s.dispose(this.scene),F.disposeScene(this.scene),this.renderer.dispose(),this.input.destroy(),(e=this.audio)==null||e.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getLapHud(){return this.lap.getHudTimes()}getBoostLevel(){var t;return(t=this.car)!=null&&t.getBoostLevel?this.car.getBoostLevel():0}getScore(){return this.score.getScoreData()}applySettingsToAudio(){var s,e;const t=Y(B);this.steerSensitivity=((s=t==null?void 0:t.controls)==null?void 0:s.sensitivity)??1,(e=this.audio)==null||e.updateFromSettings(t)}}var se=nt('<div class="combo svelte-4p1id7"> </div>'),ie=nt('<div class="game-root svelte-4p1id7"></div> <div class="hud svelte-4p1id7"><a class="home-btn svelte-4p1id7" aria-label="Home" title="Home" style="pointer-events:auto">Home</a> <div class="score-section svelte-4p1id7"><div class="score svelte-4p1id7"> </div> <div class="distance svelte-4p1id7"> </div> <!></div> <div class="speed svelte-4p1id7"> </div> <div class="laps svelte-4p1id7"><div> </div> <div> </div></div> <div class="help svelte-4p1id7">W/S or ↑/↓: Throttle/Brake • A/D or ←/→: Steer • Space: Handbrake • Shift: Boost • R: Reset</div> <button class="mute svelte-4p1id7" aria-label="Toggle mute" title="Toggle mute"> </button> <div class="boost svelte-4p1id7"><div class="bar svelte-4p1id7"><div class="fill svelte-4p1id7"></div></div></div> <div class="speed-indicator svelte-4p1id7"><div class="speed-bar svelte-4p1id7"><div class="speed-fill svelte-4p1id7"></div></div> <div class="speed-text svelte-4p1id7"> </div></div></div>',1);function ge(m,t){At(t,!1);let s=k(null),e=null,i=k(0),o=k(0),c=k(null),d=k(!1),w=.8,l=k(1),a=k(0),n=k(0),g=k(0);yt(()=>{if(!u(s))return;e=new ee(u(s)),e.init();const h=setInterval(()=>{var p;if(e){y(i,Math.round(e.currentSpeed*3.6));const M=(p=e.getLapHud)==null?void 0:p.call(e);if(M&&(y(o,M.current),y(c,M.best??null)),e.getBoostLevel&&y(l,e.getBoostLevel()),e.getScore){const L=e.getScore();y(a,L.total),y(n,Math.round(L.distance)),y(g,L.combo)}}},100);return()=>{clearInterval(h),e==null||e.destroy()}}),Mt(()=>{e==null||e.destroy(),e=null});function S(){const h=Y(B);h.audio.master>0?(w=h.audio.master,B.update(p=>({...p,audio:{...p.audio,master:0}})),y(d,!0)):(B.update(p=>({...p,audio:{...p.audio,master:w||.8}})),y(d,!1))}function _(h){const p=Math.floor(h/6e4),M=Math.floor(h%6e4/1e3),L=Math.floor(h%1e3/10);return`${p}:${String(M).padStart(2,"0")}.${String(L).padStart(2,"0")}`}function J(h){return h<=20?"#00ff00":h<=40?"#7fff00":h<=60?"#ffff00":h<=80?"#ff7f00":h<=120?"#ff4500":h<=160?"#ff0000":"#ff00ff"}var P={formatMs:_};Et();var E=ie(),I=Ct(E);Bt(I,h=>y(s,h),()=>u(s));var z=b(I,2),R=f(z),D=b(R,2),G=f(D),H=f(G);v(G);var T=b(G,2),ct=f(T);v(T);var ht=b(T,2);{var dt=h=>{var p=se(),M=f(p);v(p),it(()=>A(M,`Combo: x${u(g)??""}`)),rt(h,p)};Dt(ht,h=>{u(g)>1&&h(dt)})}v(D);var V=b(D,2),lt=f(V);v(V);var W=b(V,2),O=f(W),pt=f(O);v(O);var Q=b(O,2),ut=f(Q);v(Q),v(W);var $=b(W,4),mt=f($,!0);v($);var X=b($,2),tt=f(X),ft=f(tt);v(tt),v(X);var et=b(X,2),K=f(et),vt=f(K);v(K);var st=b(K,2),wt=f(st);return v(st),v(et),v(z),it((h,p,M,L,gt)=>{Tt(R,"href",`${qt}/`),A(H,`Score: ${h??""}`),A(ct,`Distance: ${u(n)??""}m`),A(lt,`${u(i)??""} km/h`),A(pt,`Lap: ${p??""}`),A(ut,`Best: ${M??""}`),A(mt,u(d)?"Unmute":"Mute"),at(ft,L),at(vt,gt),A(wt,`${u(i)??""} km/h`)},[()=>u(a).toLocaleString(),()=>_(u(o)),()=>u(c)===null?"--":_(u(c)),()=>`width:${Math.round(u(l)*100)}%`,()=>`width:${Math.min(u(i)/200*100,100)}%; background: ${J(u(i))}`]),_t("click",$,Pt(S)),rt(m,E),Yt(t,"formatMs",_),Lt(P)}export{ge as component};
