var He=Object.defineProperty;var $e=(T,e,t)=>e in T?He(T,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):T[e]=t;var l=(T,e,t)=>$e(T,typeof e!="symbol"?e+"":e,t);import"../chunks/Bzak7iHL.js";import"../chunks/DLP-JChq.js";import{o as Le,a as We}from"../chunks/D7t-Q6zm.js";import{aw as he,c as ee,j as U,p as Ue,l as Ne,b as Fe,f as q,t as Q,i as ge,k as Ve,s as D,d as B,g as i,m as H,o as z,x as Oe,w as R,u as ye}from"../chunks/DmiIK6kV.js";import{g as ve,s as O}from"../chunks/B6u73DSu.js";import{l as ze,s as xe,i as oe}from"../chunks/p4z5VYU4.js";import{I as Ie,e as Ze,f as qe}from"../chunks/B7T05OMM.js";import{s as be}from"../chunks/DNZA2biE.js";import{b as Xe}from"../chunks/CzH18Rhg.js";import{i as je}from"../chunks/CkuCw-0Z.js";import{s as Ye,a as Qe}from"../chunks/klbuo-dt.js";import{R as Je,p as Ke}from"../chunks/DYbPiqHX.js";import{S as et,P as tt,W as st,C as at,a as it,I as nt,R as ot,b as rt,c as lt,E as ct,T as ht,d as dt,e as Se,A as pt,M as W,V as J,Q as ut,f as re,L as ft,g as mt,h as wt,G as gt,i as le,B as Me,j as K,k as yt,l as ke,D as vt,H as bt,m as St,n as Mt,o as kt}from"../chunks/DpCHW3az.js";import{s as ce}from"../chunks/CPAs49g0.js";import{b as zt}from"../chunks/UGifly5_.js";import{s as _e}from"../chunks/D2y1D9hg.js";function xt(T,e){const t=ze(e,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}]];Ie(T,xe({name:"house"},()=>t,{get iconNode(){return s},children:(a,o)=>{var h=he(),n=ee(h);_e(n,e,"default",{}),U(a,h)},$$slots:{default:!0}}))}function It(T,e){const t=ze(e,["children","$$slots","$$events","$$legacy"]);/**
 * @license lucide-svelte v0.544.0 - ISC
 *
 * ISC License
 *
 * Copyright (c) for portions of Lucide are held by Cole Bemis 2013-2023 as part of Feather (MIT). All other copyright (c) for Lucide are held by Lucide Contributors 2025.
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * ---
 *
 * The MIT License (MIT) (for portions derived from Feather)
 *
 * Copyright (c) 2013-2023 Cole Bemis
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */const s=[["path",{d:"M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"}],["path",{d:"M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"}],["path",{d:"M18 9h1.5a1 1 0 0 0 0-5H18"}],["path",{d:"M4 22h16"}],["path",{d:"M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"}],["path",{d:"M6 9H4.5a1 1 0 0 1 0-5H6"}]];Ie(T,xe({name:"trophy"},()=>t,{get iconNode(){return s},children:(a,o)=>{var h=he(),n=ee(h);_e(n,e,"default",{}),U(a,h)},$$slots:{default:!0}}))}class _t{constructor(e,t){l(this,"scene");l(this,"camera");l(this,"renderer");l(this,"clock");l(this,"physics");l(this,"input");l(this,"renderSystem");l(this,"chaseCamera");l(this,"environment");l(this,"track");l(this,"audio");l(this,"collision");l(this,"gameMode");l(this,"running",!1);l(this,"disposeBag",[]);l(this,"frameTimeBuffer",[]);l(this,"frameTimeBufferSize",5);l(this,"players",new Map);l(this,"localId");l(this,"countdown",3);l(this,"countdownStartAt",null);l(this,"raceStarted",!1);l(this,"finishZ",600);l(this,"winnerId",null);l(this,"frozen",!1);l(this,"finishGate");l(this,"finishGateBannerMat");l(this,"throttleInput",0);l(this,"muted",!1);l(this,"currentSpeed",0);l(this,"loop",()=>{if(!this.running)return;const e=this.clock.getDelta(),t=Math.min(e,.1);this.frameTimeBuffer.push(t),this.frameTimeBuffer.length>this.frameTimeBufferSize&&this.frameTimeBuffer.shift();const s=this.frameTimeBuffer.reduce((a,o)=>a+o,0)/this.frameTimeBuffer.length;this.update(s),this.render(),requestAnimationFrame(this.loop)});l(this,"updateSize",()=>{const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderSystem.updateSize&&this.renderSystem.updateSize(e,t)});var a;this.container=e,this.scene=new et,this.camera=new tt(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new st({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new at,this.physics=new it,this.input=new nt(e),this.renderSystem=new ot(this.scene,this.camera,this.renderer),this.chaseCamera=new rt(this.camera);const s=t.find(o=>o.isLocal);this.localId=s?s.id:(a=t[0])==null?void 0:a.id,t.forEach(o=>{this.players.set(o.id,{info:o,car:null,label:null})})}init(e){const t=ve(ce);this.renderer.setPixelRatio(Math.min(devicePixelRatio,t.graphics.resolution)),this.renderer.shadowMap.enabled=!!t.graphics.shadows,this.renderer.shadowMap.type=lt,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.initializeGameMode(t.gameplay.gameMode),this.environment=new ct(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new ht,this.scene.add(this.track.group),this.collision=new dt(this.track.obstacles),this.createOrUpdateFinishGate(),Array.from(this.players.keys()).forEach(d=>{const m=new Se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});m.setPosition(0,0,0),m.setHeading(0),this.scene.add(m.group);const p=this.createNameLabel(this.players.get(d).info.name);m.group.add(p),p.position.set(0,1.8,0),this.players.set(d,{...this.players.get(d),car:m,label:p})}),this.relineUpGrid(),this.audio=new pt(this.camera),this.applySettingsToAudio();const a=ce.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>a());const o=async()=>{var d;await((d=this.audio)==null?void 0:d.resume()),window.removeEventListener("keydown",o,!0),window.removeEventListener("pointerdown",o,!0),this.disposeBag=this.disposeBag.filter(m=>m!==h)},h=()=>{window.removeEventListener("keydown",o,!0),window.removeEventListener("pointerdown",o,!0)};window.addEventListener("keydown",o,!0),window.addEventListener("pointerdown",o,!0),this.disposeBag.push(h);const n=this.players.get(this.localId).car;this.chaseCamera.update(0,n.group),this.running=!0,this.clock.start(),this.loop(),e?this.countdownStartAt=e:this.countdownStartAt=Date.now()}update(e){var M,v,g,w;if(this.frozen)return;this.physics.update(e);const t=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const c=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(c)),c>=3&&(this.raceStarted=!0)}if(this.raceStarted){const c=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),y=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),k=this.input.isDown("Space"),x=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),b=W.clamp(this.input.getSteerValue(),-1,1);t.car.setInputs({throttle:c,brake:y,steering:b,handbrake:k,boost:x}),this.throttleInput=c}else t.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1}),this.throttleInput=0;if(this.players.forEach(({car:c})=>c.update(e)),this.currentSpeed=t.car.getSpeed(),this.chaseCamera.update(e,t.car.group),this.resolveLocalCarCollisions(),(M=this.audio)==null||M.setEngine(this.throttleInput,this.currentSpeed,t.car.config.maxSpeed),this.track.update(t.car.group.position.z),(v=this.environment)==null||v.update(t.car.group.position.z),(g=this.gameMode)==null||g.updateEnvironment(e,t.car.group.position),this.finishGate&&this.finishGateBannerMat){const c=this.finishZ-t.car.group.position.z;if(c<=0)this.finishGateBannerMat.opacity=1,this.finishGate.visible=!0;else if(c<160){const y=1-c/160;this.finishGateBannerMat.opacity=W.clamp(.12+.88*y,.12,1),this.finishGate.visible=!0}else this.finishGateBannerMat.opacity=.12,this.finishGate.visible=!1}const s=this.camera.position;this.players.forEach(({car:c,label:y})=>{var N;if(!y)return;const k=s.distanceTo(c.group.position),x=8,I=W.clamp((k-x)/(45-x),0,1),_=W.lerp(1,.65,I),A=((N=y.userData)==null?void 0:N.baseScale)||{w:1.05,h:.35};y.scale.set(A.w*_,A.h*_,1);const P=y.material;P&&(P.opacity=W.lerp(1,.85,I))});const a=t.car.group.position,o=.6,h=1.2,n={minX:a.x-o,maxX:a.x+o,minZ:a.z-h,maxZ:a.z+h},d=t.car.getVelocityRef().clone();if(this.collision.resolve(a,t.car.getVelocityRef(),n)){const c=t.car.getVelocityRef(),y=d.clone().sub(c),k=W.clamp(y.length()*.1,0,1);(w=this.audio)==null||w.playCollision(k)}const p=25;if(Math.abs(a.x)>p&&(a.x=W.clamp(a.x,-p,p)),!this.winnerId){for(const[c,y]of this.players)if(y.car.group.position.z>=this.finishZ){this.winnerId=c;break}}}render(){this.renderSystem.render()}resolveLocalCarCollisions(){var m;const e=this.players.get(this.localId);if(!e)return;const t=e.car.group.position,s=e.car.getVelocityRef(),o=.7*2,h=o*o,n=new J;let d=0;if(this.players.forEach((p,M)=>{if(M===this.localId)return;const v=p.car.group.position;n.copy(v).sub(t);const g=n.x,w=n.z,c=g*g+w*w;if(c>0&&c<h){const y=Math.sqrt(c)||1e-6,k=new J(g/y,0,w/y),x=o-y;t.addScaledVector(k,-x);const b=s.dot(k);b>0&&(s.addScaledVector(k,-1.2*b),d+=Math.abs(b))}}),d>0){const p=W.clamp(d*.15,0,1);(m=this.audio)==null||m.playCollision(p)}}destroy(){var e,t,s;this.running=!1,this.clock.stop(),this.disposeBag.forEach(a=>a()),(e=this.gameMode)==null||e.dispose(),(t=this.environment)==null||t.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),(s=this.audio)==null||s.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}setMuted(e){this.muted=e,this.applySettingsToAudio()}resetForReplay(e){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(t=>{t.car.reset(new J(0,0,0),0)}),this.relineUpGrid(),this.finishGate&&this.finishGateBannerMat&&(this.finishGate.position.set(0,0,this.finishZ),this.finishGate.visible=!1,this.finishGateBannerMat.opacity=.12),this.countdownStartAt=e||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const e=this.players.get(this.localId),t=e.car.group.position,s=e.car.group.quaternion;return{p:[t.x,t.y,t.z],q:[s.x,s.y,s.z,s.w]}}applyRemoteTransform(e,t,s){const a=this.players.get(e);if(!a||e===this.localId)return;const o=new J(t[0],t[1],t[2]),h=new ut(s[0],s[1],s[2],s[3]);a.car.group.position.lerp(o,.35),a.car.group.quaternion.slerp(h,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(e){if(this.players.has(e.id))return;const t=new Se({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});t.setPosition(0,0,0),t.setHeading(0),this.scene.add(t.group);const s=this.createNameLabel(e.name);t.group.add(s),s.position.set(0,1.8,0),this.players.set(e.id,{info:e,car:t,label:s}),this.raceStarted||this.relineUpGrid()}removePlayer(e){const t=this.players.get(e);if(t){try{this.scene.remove(t.car.group)}catch{}this.players.delete(e),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const e=[];return this.players.forEach((t,s)=>{e.push({id:s,name:t.info.name,z:t.car.group.position.z})}),e}relineUpGrid(){const e=Array.from(this.players.keys()),s=Math.min(4,Math.max(2,Math.ceil(Math.sqrt(e.length)))),a=2.8,o=5.4,h=-8;e.forEach((n,d)=>{const m=Math.floor(d/s),p=d%s,v=-((s-1)*a)/2+p*a,g=h-m*o-(m%2?.6:0),w=this.players.get(n);w.car.setPosition(v,0,g),w.car.setHeading(0)})}applySettingsToAudio(){const e=ve(ce);this.audio&&(this.muted?this.audio.updateFromSettings({audio:{master:0,engine:e.audio.engine,effects:e.audio.effects,music:e.audio.music,spatial:e.audio.spatial}}):this.audio.updateFromSettings(e))}createNameLabel(e){const t=document.createElement("canvas");t.width=256,t.height=96;const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const a=18,o=t.width-a*2,h=56,n=12,d=12,m=a,p=(t.height-h-n)/2;let M=22;s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff";do{if(s.font=`700 ${M}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,s.measureText(e).width<=o-a||M<=13)break;M-=1}while(M>13);const v=(I,_,A,P,N)=>{const L=Math.min(N,P/2,A/2);s.beginPath(),s.moveTo(I+L,_),s.arcTo(I+A,_,I+A,_+P,L),s.arcTo(I+A,_+P,I,_+P,L),s.arcTo(I,_+P,I,_,L),s.arcTo(I,_,I+A,_,L),s.closePath()};s.save(),s.shadowColor="rgba(0,0,0,0.35)",s.shadowBlur=8,s.shadowOffsetY=2,v(m,p,o,h,d),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.restore();const g=m+o/2,w=p+h-1;s.beginPath(),s.moveTo(g-10,w),s.lineTo(g+10,w),s.lineTo(g,w+n),s.closePath(),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.lineWidth=1,s.strokeStyle="rgba(255,255,255,0.18)",v(m,p,o,h,d),s.stroke(),s.fillStyle="#fff",s.fillText(e,t.width/2,p+h/2);const c=new re(t);c.minFilter=ft;const y=new mt({map:c,transparent:!0,depthTest:!0,depthWrite:!1}),k=new wt(y),x=1.05,b=.35;return k.scale.set(x,b,1),k.userData={...k.userData,baseScale:{w:x,h:b}},k}createOrUpdateFinishGate(){const e=new gt,t=new le({color:2237994}),s=new le({color:2764596}),a=12,o=.6,h=.8,n=4.2,d=.5,m=.7,p=new Me(o,n,h),M=new K(p,t),v=new K(p,t);M.position.set(-a,n/2,0),v.position.set(a,n/2,0),e.add(M,v);const g=new Me(a*2+o,d,m),w=new K(g,s);w.position.set(0,n+d/2,0),e.add(w);const c=a*2-2,y=1.8,k=new yt(c,y);if(this.finishGateBannerMat){const b=this.makeFinishBannerTexture(20,4);b.wrapS=b.wrapT=ke,b.needsUpdate=!0,this.finishGateBannerMat.map=b,this.finishGateBannerMat.needsUpdate=!0}else{const b=this.makeFinishBannerTexture(20,4);b.wrapS=b.wrapT=ke,b.needsUpdate=!0,this.finishGateBannerMat=new le({map:b,transparent:!0,opacity:.12,depthWrite:!1,side:vt})}const x=new K(k,this.finishGateBannerMat);if(x.rotation.y=Math.PI,x.position.set(0,n-y/2,0),e.add(x),e.position.set(0,0,this.finishZ),e.visible=!1,this.finishGate)try{this.scene.remove(this.finishGate)}catch{}this.finishGate=e,this.scene.add(e)}makeCheckerTexture(e=8,t=2){const s=document.createElement("canvas");s.width=512,s.height=64;const a=s.getContext("2d"),o=s.width/e,h=s.height/t;for(let n=0;n<t;n++)for(let d=0;d<e;d++){const m=(n+d)%2===0;a.fillStyle=m?"#111":"#eee",a.fillRect(d*o,n*h,o,h)}return new re(s)}makeFinishBannerTexture(e=20,t=4){const s=document.createElement("canvas");s.width=1024,s.height=256;const a=s.getContext("2d"),o=s.width/e,h=s.height/t;for(let v=0;v<t;v++)for(let g=0;g<e;g++){const w=(v+g)%2===0;a.fillStyle=w?"#111":"#eee",a.fillRect(g*o,v*h,o,h)}a.fillStyle="rgba(0,0,0,0.18)",a.fillRect(0,0,s.width,s.height);const n="FINISH";let d=180;const m=40;a.textAlign="center",a.textBaseline="middle";do{if(a.font=`900 ${d}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,a.measureText(n).width<=s.width-m*2||d<=72)break;d-=4}while(d>72);a.save(),a.shadowColor="rgba(0,0,0,0.6)",a.shadowBlur=8,a.shadowOffsetY=4,a.lineWidth=Math.max(6,Math.floor(d*.06)),a.strokeStyle="rgba(0,0,0,0.9)",a.fillStyle="#ffffff";const p=s.width/2,M=s.height/2+6;return a.strokeText(n,p,M),a.fillText(n,p,M),a.restore(),new re(s)}initializeGameMode(e){var t;switch(this.audio&&(e!=="horror"?this.audio.disableHorrorAmbient():(this.audio.enableHorrorAmbient(),this.startHorrorEffects())),(t=this.gameMode)==null||t.dispose(),e){case"sunny":this.gameMode=new Mt;break;case"cloudy":this.gameMode=new St;break;case"horror":this.gameMode=new bt;break}this.gameMode.initialize(this.scene,this.renderer)}switchGameMode(e){this.initializeGameMode(e)}startHorrorEffects(){const e=()=>{if(!this.audio||!this.running)return;const t=8e3+Math.random()*17e3;setTimeout(()=>{if(!this.audio||!this.running)return;const s=["whisper","creak","distant-scream","heartbeat"],a=s[Math.floor(Math.random()*s.length)];this.audio.playHorrorEffect(a),e()},t)};e()}}class Tt{constructor(e,t,s,a){l(this,"ws",null);l(this,"url");l(this,"roomId");l(this,"playerId");l(this,"name");l(this,"reconnectDelay",1e3);l(this,"handlers",[]);l(this,"closed",!1);this.url=e,this.roomId=t,this.playerId=s,this.name=a||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);if(!t||!t.t)return;this.emit(t)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(e){for(const t of this.handlers)try{t(e)}catch{}}close(){var e;this.closed=!0;try{(e=this.ws)==null||e.close()}catch{}}on(e){this.handlers.push(e)}send(e){var t;try{((t=this.ws)==null?void 0:t.readyState)===1&&this.ws.send(JSON.stringify(e))}catch{}}sendState(e,t){this.send({t:"state",p:e,q:t})}sendLeaderboard(e){this.send({t:"lb",list:e})}}var Gt=q('<div class="countdown svelte-lzoy4r"> </div>'),Bt=q('<div class="winner icon-text svelte-lzoy4r"><!> </div>'),Rt=q('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),Ct=q('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),Et=q('<div class="game-root svelte-lzoy4r"></div> <!> <div class="hud svelte-lzoy4r"><a class="home-btn svelte-lzoy4r" aria-label="Home" title="Home" style="pointer-events:auto"><!> <span>Home</span></a> <!> <div class="speed svelte-lzoy4r"> </div> <div class="audio-controls svelte-lzoy4r" style="pointer-events:auto"><button class="mute-btn svelte-lzoy4r"> </button></div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function Jt(T,e){Ue(e,!1);const t=()=>Qe(Ke,"$page",s),[s,a]=Ye(),o=H();let h=H(null),n=H(null),d=H(3),m=H(0),p=H(null),M=H([]),v=H(!1),g=H(!1),w,c=H(null);Le(()=>{w=new Je,z(c,null);const u=localStorage.getItem("playerName")||"Anonymous";i(h)&&(async()=>{var fe,me;let r=await w.fetchRoom(i(o));if(!r)try{await w.joinRoom(i(o),u),r=await w.fetchRoom(i(o))}catch{}if(!r){alert("Room not found or no longer available."),history.back();return}const f=w.getPlayerId();if(!!!((fe=r.players)!=null&&fe[f])&&r.status==="waiting")try{await w.joinRoom(i(o),u),r=await w.fetchRoom(i(o))||r}catch{}const C=Object.values(r.players||{}).map(S=>({id:S.id,name:S.name||"Anonymous",isLocal:S.id===f})),E="wss://public_game_ws.realbrain.cc";z(c,new Tt(E,r.id,f,u)),i(c).connect(),z(n,new _t(i(h),C));const V=typeof r.raceStartAt=="number"?r.raceStartAt:void 0;i(n).init(V);const ie=setInterval(()=>{if(!i(n)||!i(c))return;const{p:S,q:F}=i(n).getLocalTransform();i(c).sendState(S,F)},66);(me=i(c))==null||me.on(S=>{if(i(n))if(S.t==="state")i(n).applyRemoteTransform(S.id,S.p,S.q);else if(S.t==="players"){const F=new Set(i(n).getPlayerIds()),Y=new Set(S.list.map(G=>G.id));S.list.forEach(G=>{F.has(G.id)||i(n).addPlayer({id:G.id,name:G.name,isLocal:G.id===f})}),F.forEach(G=>{Y.has(G)||i(n).removePlayer(G)})}else S.t==="lb"?z(M,S.list):S.t==="winner"?i(p)||(z(p,S.name||"Unknown"),z(v,!0)):S.t==="restart"&&(z(p,null),z(v,!1),i(n).resetForReplay(S.startAt))});const De=setInterval(()=>{var S,F,Y;if(i(n)){z(d,i(n).getCountdown()),z(m,Math.round(i(n).currentSpeed*3.6));const G=i(n).getWinnerId();G&&!i(p)&&(z(p,((S=C.find(Z=>Z.id===G))==null?void 0:S.name)||"Unknown"),(F=i(c))==null||F.send({t:"winner",id:G,name:i(p)}),z(v,!0));const we=i(n).getPlayerStates().sort((Z,ne)=>ne.z-Z.z).map((Z,ne)=>({...Z,rank:ne+1}));z(M,we),(Y=i(c))==null||Y.sendLeaderboard(we)}},100);x=w.subscribeToRoom(r.id,()=>{}),y=De,k=ie})()});let y=null,k=null,x=null;We(()=>{var u,r;(u=i(n))==null||u.destroy(),z(n,null),y&&clearInterval(y),k&&clearInterval(k),x&&x(),(r=i(c))==null||r.close()});function b(u){var r,f;(f=(r=i(n))==null?void 0:r.input)==null||f.setMobileThrottle(u)}function I(u){var r,f;(f=(r=i(n))==null?void 0:r.input)==null||f.setMobileBrake(u)}function _(u){var r,f;(f=(r=i(n))==null?void 0:r.input)==null||f.setMobileSteer(u)}function A(u){var r,f;(f=(r=i(n))==null?void 0:r.input)==null||f.setMobileHandbrake(u)}function P(u){var r,f;(f=(r=i(n))==null?void 0:r.input)==null||f.setMobileBoost(u)}Ne(()=>t(),()=>{z(o,t().params.roomId)}),Fe(),je();var N=Et(),L=ee(N);Xe(L,u=>z(h,u),()=>i(h));var de=D(L,2);kt(de,{onThrottle:b,onBrake:I,onSteer:_,onHandbrake:A,onBoost:P});var te=D(de,2),X=B(te),Te=B(X);xt(Te,{size:18}),Oe(2),R(X);var pe=D(X,2);{var Ge=u=>{var r=Gt(),f=B(r,!0);R(r),Q(()=>O(f,i(d))),U(u,r)},Be=u=>{var r=he(),f=ee(r);{var $=C=>{var E=Bt(),V=B(E);It(V,{size:20});var ie=D(V);R(E),Q(()=>O(ie,` Winner: ${i(p)??""}`)),U(C,E)};oe(f,C=>{i(p)&&C($)},!0)}U(u,r)};oe(pe,u=>{i(d)>0?u(Ge):u(Be,!1)})}var se=D(pe,2),Re=B(se);R(se);var ae=D(se,2),j=B(ae),Ce=B(j,!0);R(j),R(ae);var ue=D(ae,2),Ee=D(B(ue),2);Ze(Ee,1,()=>i(M),qe,(u,r)=>{var f=Rt(),$=B(f),C=B($);R($);var E=D($,2),V=B(E,!0);R(E),R(f),Q(()=>{O(C,`${i(r),ye(()=>i(r).rank)??""}.`),O(V,(i(r),ye(()=>i(r).name)))}),U(u,f)}),R(ue),R(te);var Ae=D(te,2);{var Pe=u=>{var r=Ct(),f=B(r);R(r),ge("click",f,()=>{var C,E;const $=Date.now()+3e3;(C=i(c))==null||C.send({t:"restart",startAt:$}),(E=i(n))==null||E.resetForReplay($),z(p,null),z(v,!1)}),U(u,r)};oe(Ae,u=>{i(p)&&i(v)&&u(Pe)})}Q(()=>{be(X,"href",`${zt}/`),O(Re,`${i(m)??""} km/h`),be(j,"aria-pressed",i(g)),O(Ce,i(g)?"Unmute":"Mute")}),ge("click",j,()=>{var u;z(g,!i(g)),(u=i(n))==null||u.setMuted(i(g))}),U(T,N),Ve(),a()}export{Jt as component};
