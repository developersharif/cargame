var ue=Object.defineProperty;var me=(M,t,e)=>t in M?ue(M,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):M[t]=e;var i=(M,t,e)=>me(M,typeof t!="symbol"?t+"":t,e);import"../chunks/Bzak7iHL.js";import"../chunks/DrS1WK7l.js";import{o as fe,a as we}from"../chunks/D-KRtMmF.js";import{a1 as ye,a2 as ge,a3 as ve,a4 as j,a6 as ae,a7 as K,a9 as $,aa as be,x as f,v as E,w as a,a5 as F,a8 as L,ad as W,ak as Se,u as re}from"../chunks/BaFMXX1b.js";import{g as ie,a as Z,e as Ie}from"../chunks/CcETWVYL.js";import{i as Q}from"../chunks/BsF4dGg2.js";import{e as ze,R as ke,i as Re,p as _e}from"../chunks/M787uHq2.js";import{b as xe}from"../chunks/_Chv9gBj.js";import{i as Ae}from"../chunks/BDHLh8UG.js";import{s as De,a as Pe}from"../chunks/23JgfLWk.js";import{S as Me,P as Te,W as Ce,C as Ee,a as Le,I as We,R as Ne,b as Ue,c as Ge,E as $e,T as Fe,d as He,e as ne,A as Ve,M as H,V as oe,Q as Xe,f as Be,L as Ze,g as je,h as qe}from"../chunks/DXnvPKNF.js";import{s as Y}from"../chunks/DSzE6Y4I.js";import"../chunks/CJ4O2v7I.js";class Ke{constructor(t,e){i(this,"scene");i(this,"camera");i(this,"renderer");i(this,"clock");i(this,"physics");i(this,"input");i(this,"renderSystem");i(this,"chaseCamera");i(this,"environment");i(this,"track");i(this,"audio");i(this,"collision");i(this,"running",!1);i(this,"disposeBag",[]);i(this,"players",new Map);i(this,"localId");i(this,"countdown",3);i(this,"countdownStartAt",null);i(this,"raceStarted",!1);i(this,"finishZ",600);i(this,"winnerId",null);i(this,"frozen",!1);i(this,"currentSpeed",0);i(this,"loop",()=>{if(!this.running)return;const t=this.clock.getDelta();this.update(t),this.render(),requestAnimationFrame(this.loop)});i(this,"updateSize",()=>{var s,o;const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e,!1),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),(o=(s=this.renderSystem).updateSize)==null||o.call(s,t,e)});var o;this.container=t,this.scene=new Me,this.camera=new Te(60,1,.1,1e3),this.camera.position.set(0,8,15),this.camera.lookAt(0,0,0),this.renderer=new Ce({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.clock=new Ee,this.physics=new Le,this.input=new We(t),this.renderSystem=new Ne(this.scene,this.camera,this.renderer),this.chaseCamera=new Ue(this.camera);const s=e.find(c=>c.isLocal);this.localId=s?s.id:(o=e[0])==null?void 0:o.id,e.forEach(c=>{this.players.set(c.id,{info:c,car:null,label:null})})}init(t){const e=ie(Y);this.renderer.setPixelRatio(Math.min(devicePixelRatio,e.graphics.resolution)),this.renderer.shadowMap.enabled=!!e.graphics.shadows,this.renderer.shadowMap.type=Ge,this.updateSize(),this.container.appendChild(this.renderer.domElement),window.addEventListener("resize",this.updateSize),this.disposeBag.push(()=>window.removeEventListener("resize",this.updateSize)),this.environment=new $e(this.renderer),this.environment.setup(this.scene),this.scene.add(this.environment.group),this.track=new Fe,this.scene.add(this.track.group),this.collision=new He(this.track.obstacles),Array.from(this.players.keys()).forEach(p=>{const r=new ne({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});r.setPosition(0,0,0),r.setHeading(0),this.scene.add(r.group);const g=this.createNameLabel(this.players.get(p).info.name);r.group.add(g),g.position.set(0,1.8,0),this.players.set(p,{...this.players.get(p),car:r,label:g})}),this.relineUpGrid(),this.audio=new Ve(this.camera),this.applySettingsToAudio();const o=Y.subscribe(()=>this.applySettingsToAudio());this.disposeBag.push(()=>o());const c=this.players.get(this.localId).car;this.chaseCamera.update(0,c.group),this.running=!0,this.clock.start(),this.loop(),t?this.countdownStartAt=t:this.countdownStartAt=Date.now()}update(t){var b,S;if(this.frozen)return;this.physics.update(t);const e=this.players.get(this.localId);if(!this.raceStarted&&this.countdownStartAt){const l=(Date.now()-this.countdownStartAt)/1e3;this.countdown=Math.max(0,3-Math.floor(l)),l>=3&&(this.raceStarted=!0)}if(this.raceStarted){const l=Number(this.input.isDown("ArrowUp")||this.input.isDown("KeyW")),d=Number(this.input.isDown("ArrowDown")||this.input.isDown("KeyS")),z=this.input.isDown("Space"),x=this.input.isDown("ShiftLeft")||this.input.isDown("ShiftRight"),k=Number(this.input.isDown("ArrowLeft")||this.input.isDown("KeyA")),A=Number(this.input.isDown("ArrowRight")||this.input.isDown("KeyD")),D=H.clamp(k-A,-1,1);e.car.setInputs({throttle:l,brake:d,steering:D,handbrake:z,boost:x})}else e.car.setInputs({throttle:0,brake:1,steering:0,handbrake:!0,boost:!1});this.players.forEach(({car:l})=>l.update(t)),this.currentSpeed=e.car.getSpeed(),this.chaseCamera.update(t,e.car.group),this.track.update(e.car.group.position.z),(b=this.environment)==null||b.update(e.car.group.position.z);const s=this.camera.position;this.players.forEach(({car:l,label:d})=>{var P;if(!d)return;const z=s.distanceTo(l.group.position),x=8,A=H.clamp((z-x)/(45-x),0,1),D=H.lerp(1,.65,A),w=((P=d.userData)==null?void 0:P.baseScale)||{w:1.05,h:.35};d.scale.set(w.w*D,w.h*D,1);const y=d.material;y&&(y.opacity=H.lerp(1,.85,A))});const o=e.car.group.position,c=.6,p=1.2,r={minX:o.x-c,maxX:o.x+c,minZ:o.z-p,maxZ:o.z+p},g=e.car.getVelocityRef().clone();if(this.collision.resolve(o,e.car.getVelocityRef(),r)){const l=e.car.getVelocityRef(),d=g.clone().sub(l),z=H.clamp(d.length()*.1,0,1);(S=this.audio)==null||S.playCollision(z)}const m=25;if(Math.abs(o.x)>m&&(o.x=H.clamp(o.x,-m,m)),!this.winnerId){for(const[l,d]of this.players)if(d.car.group.position.z>=this.finishZ){this.winnerId=l;break}}}render(){this.renderSystem.render()}destroy(){var t;this.running=!1,this.clock.stop(),this.disposeBag.forEach(e=>e()),(t=this.environment)==null||t.dispose(this.scene),this.renderer.dispose(),this.input.destroy(),this.renderer.domElement.parentElement===this.container&&this.container.removeChild(this.renderer.domElement)}getCountdown(){return Math.max(0,this.countdown)}hasStarted(){return this.raceStarted}getWinnerId(){return this.winnerId}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}resetForReplay(t){this.winnerId=null,this.raceStarted=!1,this.frozen=!1,this.players.forEach(e=>{e.car.reset(new oe(0,0,0),0)}),this.relineUpGrid(),this.countdownStartAt=t||Date.now(),this.countdown=3}getLocalId(){return this.localId}getLocalTransform(){const t=this.players.get(this.localId),e=t.car.group.position,s=t.car.group.quaternion;return{p:[e.x,e.y,e.z],q:[s.x,s.y,s.z,s.w]}}applyRemoteTransform(t,e,s){const o=this.players.get(t);if(!o||t===this.localId)return;const c=new oe(e[0],e[1],e[2]),p=new Xe(s[0],s[1],s[2],s[3]);o.car.group.position.lerp(c,.35),o.car.group.quaternion.slerp(p,.35)}getPlayerIds(){return Array.from(this.players.keys())}addPlayer(t){if(this.players.has(t.id))return;const e=new ne({mass:1200,maxSpeed:40,acceleration:32,braking:60,handling:2.2,drag:.8,lateralGrip:8,reverseScale:.45,handbrakeGrip:.2,boost:{multiplier:1.35,capacity:6,drain:.45,regen:.22}});e.setPosition(0,0,0),e.setHeading(0),this.scene.add(e.group);const s=this.createNameLabel(t.name);e.group.add(s),s.position.set(0,1.8,0),this.players.set(t.id,{info:t,car:e,label:s}),this.raceStarted||this.relineUpGrid()}removePlayer(t){const e=this.players.get(t);if(e){try{this.scene.remove(e.car.group)}catch{}this.players.delete(t),this.raceStarted||this.relineUpGrid()}}getPlayerStates(){const t=[];return this.players.forEach((e,s)=>{t.push({id:s,name:e.info.name,z:e.car.group.position.z})}),t}relineUpGrid(){const t=Array.from(this.players.keys()),e=Math.min(3,Math.max(2,t.length)),s=2.5,o=4,c=0;t.forEach((p,r)=>{const g=Math.floor(r/e),T=r%e,b=-((e-1)*s)/2+T*s,S=c-g*o,l=this.players.get(p);l.car.setPosition(b,0,S),l.car.setHeading(0)})}applySettingsToAudio(){var e;const t=ie(Y);(e=this.audio)==null||e.updateFromSettings(t)}createNameLabel(t){const e=document.createElement("canvas");e.width=256,e.height=96;const s=e.getContext("2d");s.clearRect(0,0,e.width,e.height);const o=18,c=e.width-o*2,p=56,r=12,g=12,T=o,m=(e.height-p-r)/2;let b=22;s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff";do{if(s.font=`700 ${b}px system-ui,-apple-system,Segoe UI,Roboto,sans-serif`,s.measureText(t).width<=c-o||b<=13)break;b-=1}while(b>13);const S=(w,y,P,N,V)=>{const U=Math.min(V,N/2,P/2);s.beginPath(),s.moveTo(w+U,y),s.arcTo(w+P,y,w+P,y+N,U),s.arcTo(w+P,y+N,w,y+N,U),s.arcTo(w,y+N,w,y,U),s.arcTo(w,y,w+P,y,U),s.closePath()};s.save(),s.shadowColor="rgba(0,0,0,0.35)",s.shadowBlur=8,s.shadowOffsetY=2,S(T,m,c,p,g),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.restore();const l=T+c/2,d=m+p-1;s.beginPath(),s.moveTo(l-10,d),s.lineTo(l+10,d),s.lineTo(l,d+r),s.closePath(),s.fillStyle="rgba(20,20,24,0.68)",s.fill(),s.lineWidth=1,s.strokeStyle="rgba(255,255,255,0.18)",S(T,m,c,p,g),s.stroke(),s.fillStyle="#fff",s.fillText(t,e.width/2,m+p/2);const z=new Be(e);z.minFilter=Ze;const x=new je({map:z,transparent:!0,depthTest:!0,depthWrite:!1}),k=new qe(x),A=1.05,D=.35;return k.scale.set(A,D,1),k.userData={...k.userData,baseScale:{w:A,h:D}},k}}class Oe{constructor(t,e,s,o){i(this,"ws",null);i(this,"url");i(this,"roomId");i(this,"playerId");i(this,"name");i(this,"reconnectDelay",1e3);i(this,"handlers",[]);i(this,"closed",!1);this.url=t,this.roomId=e,this.playerId=s,this.name=o||"Anonymous"}connect(){this.closed=!1,this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.emit({t:"open"}),this.send({t:"join",roomId:this.roomId,playerId:this.playerId,name:this.name})},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);if(!e||!e.t)return;this.emit(e)}catch{}},this.ws.onclose=()=>{this.emit({t:"close"}),this.closed||(setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*2,8e3))},this.ws.onerror=()=>{}}emit(t){for(const e of this.handlers)try{e(t)}catch{}}close(){var t;this.closed=!0;try{(t=this.ws)==null||t.close()}catch{}}on(t){this.handlers.push(t)}send(t){var e;try{((e=this.ws)==null?void 0:e.readyState)===1&&this.ws.send(JSON.stringify(t))}catch{}}sendState(t,e){this.send({t:"state",p:t,q:e})}sendLeaderboard(t){this.send({t:"lb",list:t})}}var Qe=j('<div class="countdown svelte-lzoy4r"> </div>'),Ye=j('<div class="winner svelte-lzoy4r"> </div>'),Je=j('<div class="lb-row svelte-lzoy4r"><span class="rank svelte-lzoy4r"> </span> <span class="name svelte-lzoy4r"> </span></div>'),et=j('<div class="restart svelte-lzoy4r"><button class="restart-btn svelte-lzoy4r">Restart Race</button></div>'),tt=j('<div class="game-root svelte-lzoy4r"></div> <div class="hud svelte-lzoy4r"><!> <div class="speed svelte-lzoy4r"> </div> <div class="leaderboard svelte-lzoy4r"><div class="lb-title svelte-lzoy4r">Participants</div> <!></div></div> <!>',1);function yt(M,t){ye(t,!1);const e=()=>Pe(_e,"$page",s),[s,o]=De(),c=E();let p=E(null),r=E(null),g=E(3),T=E(0),m=E(null),b=E([]),S=E(!1),l,d=E(null);fe(()=>{l=new ke,f(d,null);const u=localStorage.getItem("playerName")||"Anonymous";a(p)&&(async()=>{var ee,te;let n=await l.fetchRoom(a(c));if(!n)try{await l.joinRoom(a(c),u),n=await l.fetchRoom(a(c))}catch{}if(!n){alert("Room not found or no longer available."),history.back();return}const v=l.getPlayerId();if(!!!((ee=n.players)!=null&&ee[v])&&n.status==="waiting")try{await l.joinRoom(a(c),u),n=await l.fetchRoom(a(c))||n}catch{}const R=Object.values(n.players||{}).map(h=>({id:h.id,name:h.name||"Anonymous",isLocal:h.id===v})),_="wss://public_game_ws.realbrain.cc";f(d,new Oe(_,n.id,v,u)),a(d).connect(),f(r,new Ke(a(p),R));const X=typeof n.raceStartAt=="number"?n.raceStartAt:void 0;a(r).init(X);const he=setInterval(()=>{if(!a(r)||!a(d))return;const{p:h,q:G}=a(r).getLocalTransform();a(d).sendState(h,G)},66);(te=a(d))==null||te.on(h=>{if(a(r))if(h.t==="state")a(r).applyRemoteTransform(h.id,h.p,h.q);else if(h.t==="players"){const G=new Set(a(r).getPlayerIds()),q=new Set(h.list.map(I=>I.id));h.list.forEach(I=>{G.has(I.id)||a(r).addPlayer({id:I.id,name:I.name,isLocal:I.id===v})}),G.forEach(I=>{q.has(I)||a(r).removePlayer(I)})}else h.t==="lb"?f(b,h.list):h.t==="winner"?a(m)||(f(m,h.name||"Unknown"),a(r).freeze(),f(S,!0)):h.t==="restart"&&(f(m,null),f(S,!1),a(r).resetForReplay(h.startAt))});const pe=setInterval(()=>{var h,G,q;if(a(r)){f(g,a(r).getCountdown()),f(T,Math.round(a(r).currentSpeed*3.6));const I=a(r).getWinnerId();I&&!a(m)&&(f(m,((h=R.find(B=>B.id===I))==null?void 0:h.name)||"Unknown"),a(r).freeze(),(G=a(d))==null||G.send({t:"winner",id:I,name:a(m)}),f(S,!0));const se=a(r).getPlayerStates().sort((B,O)=>O.z-B.z).map((B,O)=>({...B,rank:O+1}));f(b,se),(q=a(d))==null||q.sendLeaderboard(se)}},100);k=l.subscribeToRoom(n.id,()=>{}),z=pe,x=he})()});let z=null,x=null,k=null;we(()=>{var u,n;(u=a(r))==null||u.destroy(),f(r,null),z&&clearInterval(z),x&&clearInterval(x),k&&k(),(n=a(d))==null||n.close()}),ge(()=>e(),()=>{f(c,e().params.roomId)}),ve(),Ae();var A=tt(),D=ae(A);xe(D,u=>f(p,u),()=>a(p));var w=F(D,2),y=L(w);{var P=u=>{var n=Qe(),v=L(n,!0);W(n),K(()=>Z(v,a(g))),$(u,n)},N=u=>{var n=Se(),v=ae(n);{var C=R=>{var _=Ye(),X=L(_);W(_),K(()=>Z(X,`🏆 Winner: ${a(m)??""}`)),$(R,_)};Q(v,R=>{a(m)&&R(C)},!0)}$(u,n)};Q(y,u=>{a(g)>0?u(P):u(N,!1)})}var V=F(y,2),U=L(V);W(V);var J=F(V,2),le=F(L(J),2);ze(le,1,()=>a(b),Re,(u,n)=>{var v=Je(),C=L(v),R=L(C);W(C);var _=F(C,2),X=L(_,!0);W(_),W(v),K(()=>{Z(R,`${a(n),re(()=>a(n).rank)??""}.`),Z(X,(a(n),re(()=>a(n).name)))}),$(u,v)}),W(J),W(w);var ce=F(w,2);{var de=u=>{var n=et(),v=L(n);W(n),Ie("click",v,()=>{var R,_;const C=Date.now()+3e3;(R=a(d))==null||R.send({t:"restart",startAt:C}),(_=a(r))==null||_.resetForReplay(C),f(m,null),f(S,!1)}),$(u,n)};Q(ce,u=>{a(m)&&a(S)&&u(de)})}K(()=>Z(U,`${a(T)??""} km/h`)),$(M,A),be(),o()}export{yt as component};
