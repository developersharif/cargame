var te=Object.defineProperty;var oe=(t,e,r)=>e in t?te(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var E=(t,e,r)=>oe(t,typeof e!="symbol"?e+"":e,r);import{b as se,h as x,a as ne,w as V,an as ie,c as le,H as ue,d as q,s as z,f as H,m as T,ao as ce,ap as fe,i as O,k as de,j as he,aq as me,g as ye,v as ve,ar as B,as as X,O as pe,at as we,l as K,p as be,au as Re,av as ge,aw as F,ax as Q,ay as Ie,az as _e,aA as Pe,aB as Ee,aC as Ae}from"./BaFMXX1b.js";import{s as Ce}from"./BuBZvHOX.js";import{i as A,d as m,r as _,p as De,s as Y,g as j,u as M,o as ke,a as G,b as W,c as xe}from"./BigBxC9G.js";function Fe(t,e){return e}function Se(t,e,r){for(var a=t.items,o=[],s=e.length,l=0;l<s;l++)_e(e[l].e,o,!0);var d=s>0&&o.length===0&&r!==null;if(d){var c=r.parentNode;Pe(c),c.append(r),a.clear(),P(t,e[0].prev,e[s-1].next)}Ee(o,()=>{for(var y=0;y<s;y++){var v=e[y];d||(a.delete(v.k),P(t,v.prev,v.next)),Q(v.e,!d)}})}function Le(t,e,r,a,o,s=null){var l=t,d={flags:e,items:new Map,first:null};x&&ne();var c=null,y=!1,v=new Map,D=ie(()=>{var n=r();return pe(n)?n:n==null?[]:X(n)}),i,p;function u(){Te(p,i,d,v,l,o,e,a,r),s!==null&&(i.length===0?c?K(c):c=O(()=>s(l)):c!==null&&be(c,()=>{c=null}))}se(()=>{p??(p=Ae),i=V(D);var n=i.length;if(y&&n===0)return;y=n===0;let w=!1;if(x){var k=le(l)===ue;k!==(n===0)&&(l=q(),z(l),H(!1),w=!0)}if(x){for(var R=null,f,h=0;h<n;h++){if(T.nodeType===ce&&T.data===fe){l=T,w=!0,H(!1);break}var b=i[h],g=a(b,h);f=J(T,d,R,null,b,g,h,o,e,r),d.items.set(g,f),R=f}n>0&&z(q())}if(x)n===0&&s&&(c=O(()=>s(l)));else if(de()){var $=new Set,C=he;for(h=0;h<n;h+=1){b=i[h],g=a(b,h);var I=d.items.get(g)??v.get(g);I?Z(I,b,h):(f=J(null,d,null,null,b,g,h,o,e,r,!0),v.set(g,f)),$.add(g)}for(const[N,S]of d.items)$.has(N)||C.skipped_effects.add(S.e);C.add_callback(u)}else u();w&&H(!0),V(D)}),x&&(l=T)}function Te(t,e,r,a,o,s,l,d,c){var y=e.length,v=r.items,D=r.first,i=D,p,u=null,n=[],w=[],k,R,f,h;for(h=0;h<y;h+=1){if(k=e[h],R=d(k,h),f=v.get(R),f===void 0){var b=a.get(R);if(b!==void 0){a.delete(R),v.set(R,b);var g=u?u.next:i;P(r,u,b),P(r,b,g),L(b,g,o),u=b}else{var $=i?i.e.nodes_start:o;u=J($,r,u,u===null?r.first:u.next,k,R,h,s,l,c)}v.set(R,u),n=[],w=[],i=u.next;continue}if(Z(f,k,h),(f.e.f&F)!==0&&K(f.e),f!==i){if(p!==void 0&&p.has(f)){if(n.length<w.length){var C=w[0],I;u=C.prev;var N=n[0],S=n[n.length-1];for(I=0;I<n.length;I+=1)L(n[I],C,o);for(I=0;I<w.length;I+=1)p.delete(w[I]);P(r,N.prev,S.next),P(r,u,N),P(r,S,C),i=C,u=S,h-=1,n=[],w=[]}else p.delete(f),L(f,i,o),P(r,f.prev,f.next),P(r,f,u===null?r.first:u.next),P(r,u,f),u=f;continue}for(n=[],w=[];i!==null&&i.k!==R;)(i.e.f&F)===0&&(p??(p=new Set)).add(i),w.push(i),i=i.next;if(i===null)continue;f=i}n.push(f),u=f,i=f.next}if(i!==null||p!==void 0){for(var U=p===void 0?[]:X(p);i!==null;)(i.e.f&F)===0&&U.push(i),i=i.next;var ee=U.length;if(ee>0){var re=null;Se(r,U,re)}}t.first=r.first&&r.first.e,t.last=u&&u.e;for(var ae of a.values())Q(ae.e);a.clear()}function Z(t,e,r,a){me(t.v,e),t.i=r}function J(t,e,r,a,o,s,l,d,c,y,v){var D=(c&Re)!==0,i=(c&ge)===0,p=D?i?ve(o,!1,!1):B(o):o,u=(c&we)===0?l:B(l),n={i:u,v:p,k:s,a:null,e:null,prev:r,next:a};try{if(t===null){var w=document.createDocumentFragment();w.append(t=ye())}return n.e=O(()=>d(t,p,u,y),x),n.e.prev=r&&r.e,n.e.next=a&&a.e,r===null?v||(e.first=n):(r.next=n,r.e.next=n.e),a!==null&&(a.prev=n,a.e.prev=n.e),n}finally{}}function L(t,e,r){for(var a=t.next?t.next.e.nodes_start:r,o=e?e.e.nodes_start:r,s=t.e.nodes_start;s!==null&&s!==a;){var l=Ie(s);o.before(s),s=l}}function P(t,e,r){e===null?t.first=r:(e.next=r,e.e.next=r&&r.e),r!==null&&(r.prev=e,r.e.prev=e&&e.e)}const $e=()=>{const t=Ce;return{page:{subscribe:t.page.subscribe},navigating:{subscribe:t.navigating.subscribe},updated:t.updated}},Oe={subscribe(t){return $e().page.subscribe(t)}};class Je{constructor(){E(this,"currentRoom",null);E(this,"playerId","");E(this,"playerName","");E(this,"roomUnsubscribe",null);E(this,"onPlayerJoinCallback");E(this,"onPlayerLeaveCallback");E(this,"onRoomErrorCallback");E(this,"lastPlayerIds",new Set);if(typeof localStorage<"u"){const e=localStorage.getItem("playerId");if(e)this.playerId=e;else{this.playerId=Math.random().toString(36).substring(2,15);try{localStorage.setItem("playerId",this.playerId)}catch{}}}else this.playerId=Math.random().toString(36).substring(2,15);console.log("RoomManager initialized with player ID:",this.playerId)}setPlayerName(e){this.playerName=e}async createRoom(e){if(!A()||!m)throw new Error("Firebase is not available");try{this.playerName=e;const r={hostId:this.playerId,hostName:e,players:{[this.playerId]:{id:this.playerId,name:e,status:"not-ready",isHost:!0,joinedAt:Date.now()}},status:"waiting",maxPlayers:4,createdAt:Date.now(),updatedAt:Date.now()},a=_(m,"rooms"),o=De(a);if(!o.key)throw new Error("Failed to generate room ID");const s={id:o.key,...r};return await Y(o,s),this.currentRoom=s,console.log("Room created successfully with ID:",o.key),o.key}catch(r){throw console.error("Failed to create room:",r),r instanceof Error?r.message.includes("permission")?new Error("Firebase permission denied. Please check database rules."):r.message.includes("network")?new Error("Network error. Please check your internet connection."):new Error(`Room creation failed: ${r.message}`):new Error("Unknown error occurred while creating room")}}async joinRoom(e,r){if(!A()||!m)throw new Error("Firebase is not available");try{this.playerName=r;const a=_(m,`rooms/${e}`),o=await j(a);if(!o.exists())throw new Error("Room not found");const s=o.val();if(s.status!=="waiting")throw new Error("Room is not accepting new players");if(Object.keys(s.players).length>=s.maxPlayers)throw new Error("Room is full");const d={id:this.playerId,name:r,status:"not-ready",isHost:!1,joinedAt:Date.now()},c=_(m,`rooms/${e}/players/${this.playerId}`);await Y(c,d),await M(a,{updatedAt:Date.now()}),this.currentRoom={...s,players:{...s.players,[this.playerId]:d},updatedAt:Date.now()};try{ke(c).remove()}catch{}console.log("Successfully joined room:",e)}catch(a){throw console.error("Failed to join room:",a),a}}getCurrentRoom(){return this.currentRoom}async fetchRoom(e){if(!A()||!m)return null;try{const r=_(m,`rooms/${e}`),a=await j(r);return a.exists()?a.val():null}catch(r){return console.error("fetchRoom error",r),null}}getPlayerId(){return this.playerId}getPlayerName(){return this.playerName}isHost(){var e;return((e=this.currentRoom)==null?void 0:e.hostId)===this.playerId}async leaveRoom(){if(!(!this.currentRoom||!A()||!m))try{this.roomUnsubscribe&&(this.roomUnsubscribe(),this.roomUnsubscribe=null);const e=this.currentRoom.id,r=_(m,`rooms/${e}`);if(this.currentRoom.hostId===this.playerId)await G(r);else{const a=_(m,`rooms/${e}/players/${this.playerId}`);await G(a),await M(r,{updatedAt:Date.now()})}this.currentRoom=null,this.lastPlayerIds.clear()}catch(e){throw console.error("Failed to leave room:",e),e}}onRoomUpdate(e){if(!this.currentRoom||!A()||!m)return;const r=_(m,`rooms/${this.currentRoom.id}`);this.roomUnsubscribe&&(this.roomUnsubscribe(),this.roomUnsubscribe=null);const a=W(r,o=>{if(!o.exists()){this.currentRoom=null,e(null);return}const s=o.val(),l=new Set(this.lastPlayerIds),d=new Set(Object.keys(s.players||{}));for(const c of d)if(!l.has(c)&&this.onPlayerJoinCallback){const y=s.players[c];y&&this.onPlayerJoinCallback(y)}for(const c of l)!d.has(c)&&this.onPlayerLeaveCallback&&this.onPlayerLeaveCallback(c);this.lastPlayerIds=d,this.currentRoom=s,e(s)},o=>{console.error("Room listener error:",o),this.onRoomErrorCallback&&this.onRoomErrorCallback(o)});this.roomUnsubscribe=a}onPlayerJoin(e){this.onPlayerJoinCallback=e}onPlayerLeave(e){this.onPlayerLeaveCallback=e}onRoomError(e){this.onRoomErrorCallback=e}async startGame(){if(!this.currentRoom||!A()||!m)return;const e=_(m,`rooms/${this.currentRoom.id}`);await M(e,{status:"racing",updatedAt:Date.now(),raceStartAt:xe()}),this.currentRoom={...this.currentRoom,status:"racing",updatedAt:Date.now()}}async setHostPeerId(e){if(!this.currentRoom||!A()||!m)return;const r=_(m,`rooms/${this.currentRoom.id}`);await M(r,{hostPeerId:e,updatedAt:Date.now()}),this.currentRoom={...this.currentRoom,hostPeerId:e,updatedAt:Date.now()}}subscribeToRoom(e,r,a){if(!A()||!m)return()=>{};const o=_(m,`rooms/${e}`);return W(o,l=>{if(!l.exists()){r(null);return}r(l.val())},l=>{console.error("subscribeToRoom error:",l),a==null||a(l)})}}export{Je as R,Le as e,Fe as i,Oe as p};
